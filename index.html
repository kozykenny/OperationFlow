<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Tokyo Girls Hub - Welcome</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root{
            --pink: #EC4899;
            --pink-100: #fce7f3;
            --pink-200: #fbcfe8;
            --rose-700: #be185d;
            --violet: #8b5cf6;
        }
        html, body {
            height: 100%;
            overflow: hidden; /* Prevent scrollbars during drag */
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 50%, #fbcfe8 100%);
            color: #374151;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .page-content { display: none; }
        .page-content.active { display: flex; justify-content: center; }

        .card {
            position: relative;
            background-color: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(14px);
            border: 1px solid rgba(236, 72, 153, 0.18);
            border-radius: 1.25rem;
            padding: 3rem;
            box-shadow: 0 20px 40px -20px rgba(236, 72, 153, 0.25), 0 10px 24px -18px rgba(0,0,0,.1);
            width: 100%;
            max-width: 896px;
            transition: transform .3s ease, box-shadow .3s ease;
        }
        
        .btn {
            display: inline-flex; align-items:center; justify-content:center; gap:.5rem;
            padding: 1rem 1.75rem;
            border-radius: 0.9rem; font-weight: 600;
            transition: transform .15s ease, box-shadow .15s ease, background-color .2s ease;
            cursor: pointer; border: 1px solid transparent; text-align: center;
        }
        .btn-primary { background-color: var(--pink); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(236,72,153,.35); }
        .btn-secondary { background-color: #fff; color: var(--rose-700); border-color: var(--pink-200); }
        .btn-secondary:hover { background-color: var(--pink-100); }
        
        .logo { font-size: clamp(2.25rem, 5vw, 3rem); font-weight: 800; color: var(--pink); text-align: center; margin-bottom: 0.5rem; }
        .page-title { font-size: clamp(1.75rem, 4vw, 2.25rem); font-weight: 700; text-align: center; margin-bottom: 2rem; }
        .service-card { background:linear-gradient(180deg,#fff,rgba(255,255,255,.9)); border:1px solid rgba(236,72,153,.2); border-radius: 0.9rem; overflow: hidden; text-align: center; color: var(--rose-700); font-weight: 500; box-shadow: 0 2px 6px rgba(0,0,0,0.04); }
        .service-card img { height: 120px; width: 100%; object-fit: cover; }
        .back-button { position: absolute; top: 1rem; left: 1rem; background: white; border: 1px solid #f3f4f6; cursor: pointer; color: #6b7280; font-weight: 700; font-size: 1.2rem; line-height: 1; width:36px; height:36px; border-radius:.75rem; display:flex;align-items:center;justify-content:center; z-index: 10; }
        
        #conversation-panel, #translation-panel {
            position: fixed; right: 2rem; bottom: 10rem; width: 380px; max-width: 92vw; height: 560px;
            background: #fff; border:1px solid rgba(0,0,0,.1); border-radius:1.25rem;
            box-shadow: 0 24px 48px -24px rgba(0,0,0,.2);
            display: none; /* Initially hidden */
            flex-direction:column; overflow:hidden; z-index: 100;
            transition: width .3s ease, height .3s ease, top .3s ease, left .3s ease, right .3s ease, border-radius .3s ease;
        }
        .panel-header{ background: linear-gradient(90deg, #f3f4f6, #e5e7eb); padding: .9rem 1rem; font-weight:700; color: #374151; display:flex; align-items:center; justify-content:space-between; cursor: grab; }
        .panel-header:active { cursor: grabbing; }
        .close-panel-btn { background: none; border: none; font-size: 1.75rem; font-weight: bold; cursor: pointer; line-height: 1; color: #6b7280; opacity: 0.7; }
        .close-panel-btn:hover { opacity: 1; }
        .chat-messages{ flex:1; padding: 1rem; overflow-y:auto; display:flex; flex-direction:column; gap:.6rem; background: linear-gradient(180deg, #fff, #f9fafb 60%, #fff); }
        .chat-message { max-width: 84%; padding: 0.55rem 0.75rem; border-radius: 0.9rem; line-height: 1.4; font-size:.98rem; white-space: pre-wrap; }
        .user-message { background-color: var(--pink); color: white; align-self: flex-end; border-bottom-right-radius: 0.3rem; }
        .ai-message, .staff-message, .translation-message { background-color: #f3f4f6; color: #374151; align-self: flex-start; border-bottom-left-radius: 0.3rem; }
        .translation-message { border: 1px dashed #d1d5db; color: #6b7280; font-style: italic;}
        .typing { align-self: flex-start; background-color: #f3f4f6; color: #374151; border-bottom-left-radius: 0.3rem; display: inline-flex; align-items: center; gap: 6px; padding: 0.55rem 0.75rem; border-radius: 0.9rem; max-width: 84%; }
        
        #voice-controls {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 2rem;
            display: none;
            align-items: center;
            gap: 1.5rem;
            z-index: 50;
        }
        .control-group { text-align: center; }
        .control-button {
            width: 72px; height: 72px; border-radius: 9999px;
            color:#fff; border:none; position: relative;
            display:flex; align-items:center; justify-content:center; cursor:pointer;
            transition: transform .12s ease, box-shadow .12s ease, background .2s ease;
            transform-origin: center;
        }
        .control-button:hover{ transform: scale(1.05); }
        .control-prompt { font-size: 0.75rem; font-weight: 500; color: #4b5563; margin-top: 0.5rem; }
        #big-mic { background: var(--pink); }
        #big-mic.recording{ background:#f43f5e; transform: scale(1.1); }
        #translate-btn { background-color: var(--violet); }
        #translate-btn.recording { background: #7c3aed; transform: scale(1.1); }
        .ring { position:absolute; inset:-8px; border-radius:9999px; border:2px solid; animation: ringPulse 1.6s ease-out infinite; }
        .ring.delay { animation-delay: .35s; opacity:.6; }
        @keyframes ringPulse { 0% { transform: scale(.9); opacity:.9; } 100% { transform: scale(1.15); opacity:0; } }
        
        .speaker-toggle { display: flex; background: #e5e7eb; border-radius: .75rem; padding: .25rem; }
        .speaker-toggle button { flex: 1; padding: .5rem; border-radius: .5rem; border: none; background: transparent; font-weight: 600; color: #6b7280; transition: background-color .2s ease, color .2s ease;}
        .speaker-toggle button.active { background: white; color: var(--violet); box-shadow: 0 2px 4px rgba(0,0,0,.1); }
        
        /* Custom Dropdown Fix */
        .custom-select-container { position: relative; }
        .custom-select-options {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid var(--pink-200); border-radius: 0.75rem;
            margin-top: 0.5rem; z-index: 100; max-height: 250px; overflow-y: auto;
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1);
        }
        
        .panel.dragging { user-select: none; transition: none !important; }

    </style>
</head>
<body>

    <div id="app-container" class="w-full flex flex-col items-center p-4">
        <div id="page-language" class="page-content active"><div class="card"><h1 class="logo">Tokyo Girls Hub</h1><h2 class="page-title" data-translate-key="select_language_title">Select Your Language</h2><div class="flex flex-col space-y-4 max-w-md mx-auto"><div id="custom-language-select" class="custom-select-container"><button id="language-select-button" type="button" class="w-full p-4 bg-white border border-pink-200 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 text-center text-lg flex justify-between items-center"><span id="selected-language-name">Select Language</span><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 3a.75.75 0 01.53.22l3.5 3.5a.75.75 0 01-1.06 1.06L10 4.81 7.03 7.78a.75.75 0 01-1.06-1.06l3.5-3.5A.75.75 0 0110 3zm-3.72 9.53a.75.75 0 011.06 0L10 15.19l2.97-2.97a.75.75 0 111.06 1.06l-3.5 3.5a.75.75 0 01-1.06 0l-3.5-3.5a.75.75 0 010-1.06z" clip-rule="evenodd" /></svg></button><div id="language-options" class="custom-select-options hidden"><input type="text" id="language-search" class="w-full p-3 border-b border-pink-100 focus:outline-none focus:ring-1 focus:ring-pink-400" data-translate-key="search_placeholder" placeholder="Search language..."><ul id="language-list" class="py-1"></ul></div></div><button id="language-continue-btn" class="btn btn-primary text-lg" data-translate-key="continue_btn">Continue</button></div></div></div>
        <div id="page-first-time" class="page-content"><div class="card"><button onclick="goBack()" class="back-button">‹</button><h1 class="logo" data-translate-key="welcome">Welcome</h1><h2 class="page-title" data-translate-key="first_time_title">Is this your first time visiting us?</h2><div class="flex justify-center gap-4"><button onclick="showPage('page-services')" class="btn btn-primary w-2/5 text-lg" data-translate-key="yes_btn">Yes</button><button onclick="showPage('page-which-girl')" class="btn btn-secondary w-2/5 text-lg" data-translate-key="no_btn">No</button></div></div></div>
        <div id="page-services" class="page-content"><div class="card"><button onclick="goBack()" class="back-button">‹</button><h1 class="logo" data-translate-key="our_services_title">Our Services</h1><p class="text-center mb-6 text-lg" data-translate-key="our_services_subtitle">We are a legally registered agency. We offer the following services:</p><div class="grid grid-cols-3 gap-4 mb-6"></div><div class="text-center"><button onclick="showPage('page-disclaimer-yes')" class="btn btn-primary text-lg" data-translate-key="ok_btn">OK</button></div></div></div>
        <div id="page-disclaimer-yes" class="page-content"><div class="card text-center"><button onclick="goBack()" class="back-button">‹</button><svg class="mx-auto h-16 w-16 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg><h3 class="text-2xl font-bold text-gray-800 mt-4" data-translate-key="legal_reminder_title_serious">【Important】Disclaimer & Terms of Use</h3><div class="mt-4 text-left space-y-3 text-gray-600 text-base" data-translate-key="legal_reminder_text_serious"></div><p class="mt-6 text-gray-800 font-semibold" data-translate-key="legal_reminder_agreement"></p><div class="flex justify-center gap-4 mt-6"><button onclick="redirectToBooking()" class="btn btn-primary w-2/5 text-lg" data-translate-key="confirm_btn">Agree</button><button onclick="handleRejection()" class="btn btn-secondary w-2/5 text-lg" data-translate-key="reject_btn">Decline</button></div></div></div>
        <div id="page-rejected" class="page-content"><div class="card text-center"><h1 class="logo" data-translate-key="thank_you">Thank You</h1><p class="text-xl" data-translate-key="rejection_text">Thanks for your interest. We hope to see you again. Redirecting...</p></div></div>
        <div id="page-which-girl" class="page-content"><div class="card"><button onclick="goBack()" class="back-button">‹</button><h1 class="logo" data-translate-key="welcome_back">Welcome Back!</h1><h2 class="page-title" data-translate-key="which_girl_title">Do you remember your companion's name?</h2><form id="girl-nomination-form" class="max-w-md mx-auto"><div class="flex flex-col space-y-4"><input type="text" name="girl_name" data-translate-key="girl_name_placeholder" class="w-full p-4 bg-white border border-pink-200 rounded-lg focus:ring-pink-500 focus:border-pink-500 text-lg"><button type="submit" class="btn btn-primary text-lg" data-translate-key="submit_continue_btn">Submit & Continue</button><button type="button" id="not-sure-btn" class="btn btn-secondary text-lg" data-translate-key="not_sure_btn">I'm Not Sure</button></div></form></div></div>
        <div id="page-disclaimer-no" class="page-content"><div class="card text-center"><button onclick="goBack()" class="back-button">‹</button><svg class="mx-auto h-16 w-16 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg><h3 class="text-2xl font-bold text-gray-800 mt-4" data-translate-key="legal_reminder_title_serious">【Important】Disclaimer & Terms of Use</h3><div class="mt-4 text-left space-y-3 text-gray-600 text-base" data-translate-key="legal_reminder_text_serious"></div><p class="mt-6 text-gray-800 font-semibold" data-translate-key="legal_reminder_agreement"></p><div class="flex justify-center gap-4 mt-6"><button onclick="redirectToBooking()" class="btn btn-primary w-2/5 text-lg" data-translate-key="confirm_btn">Agree</button><button onclick="handleRejection()" class="btn btn-secondary w-2/5 text-lg" data-translate-key="reject_btn">Decline</button></div></div></div>
        <div id="page-form-success" class="page-content"><div class="card text-center"><button onclick="goBack()" class="back-button">‹</button><h1 class="logo" data-translate-key="thank_you">Thank You!</h1><p class="text-xl mb-4" data-translate-key="form_success_text">Your preference has been noted.</p><p class="mb-6 text-lg" data-translate-key="form_success_subtitle">Please proceed to the disclaimer.</p><button onclick="showPage('page-disclaimer-no')" class="btn btn-primary text-lg" data-translate-key="continue_btn">Continue</button></div></div>
    </div>

    <div id="conversation-panel" class="panel"><div id="ai-panel-header" class="panel-header"><span data-translate-key="chat_header">AI Assistant</span><button class="close-panel-btn" title="Close panel">&times;</button></div><div id="ai-chat-messages" class="chat-messages"></div></div>
    
    <div id="translation-panel" class="panel">
        <div id="translation-panel-header" class="panel-header"><span data-translate-key="translator_header">Live Translator</span><button class="close-panel-btn" title="Close panel">&times;</button></div>
        <div id="translation-chat-messages" class="chat-messages"></div>
        <div class="p-4 border-t border-gray-200">
            <div class="speaker-toggle">
                <button id="speaker-customer" class="active" data-translate-key="customer_speaker">Customer</button>
                <button id="speaker-staff" data-translate-key="staff_speaker">Staff</button>
            </div>
        </div>
    </div>
    
    <div id="voice-controls">
        <div class="control-group">
            <button id="big-mic" title="Tap to speak with AI assistant" class="control-button"><div class="ring" style="border-color: var(--pink);"></div><div class="ring delay" style="border-color: var(--pink);"></div><svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line></svg></button>
            <p class="control-prompt" data-translate-key="ai_prompt">AI Assistant</p>
        </div>
        <div class="control-group">
            <button id="translate-btn" title="Tap to speak with a translator" class="control-button"><div class="ring" style="border-color: var(--violet);"></div><div class="ring delay" style="border-color: var(--violet);"></div><svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="m7 2 3 5"/><path d="m10 14 3-3 5 5"/><path d="m14 11 5 5"/><path d="M11 22h8"/></svg></button>
            <p class="control-prompt" data-translate-key="translator_prompt">Translator</p>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const bookingUrl = 'https://tokyogirlshub.com/en/booking';
        const n8nWebhookUrl = 'https://tokyogirlshub.app.n8n.cloud/webhook/d01e21eb-14c0-41bf-8c7f-cee5a5e3371d';
        let currentLanguage = 'en';
        let pageHistory = [];
        let chatHistory = [];
        let currentChatMode = 'ai'; // 'ai' or 'translation'
        let currentSpeaker = 'customer'; // 'customer' or 'staff'
        let mediaRecorder, audioChunks = [], isRecording = false;

        // --- SESSION MANAGEMENT ---
        const SESSION_KEY = 'tgh_session_id'; const SESSION_TS_KEY = 'tgh_session_ts';
        function generateSessionId() { const buf = new Uint8Array(16); crypto.getRandomValues(buf); buf[6] = (buf[6] & 0x0f) | 0x40; buf[8] = (buf[8] & 0x3f) | 0x80; const hex = [...buf].map(b => b.toString(16).padStart(2, '0')).join(''); return `${hex.slice(0,8)}-${hex.slice(8,12)}-${hex.slice(12,16)}-${hex.slice(16,20)}-${hex.slice(20)}`; }
        function getSessionId() { let sid = sessionStorage.getItem(SESSION_KEY); if (!sid) { sid = generateSessionId(); sessionStorage.setItem(SESSION_KEY, sid); } touchSession(); return sid; }
        function resetSession() { sessionStorage.removeItem(SESSION_KEY); touchSession(true); return getSessionId(); }
        function touchSession(reset = false) { if (reset) { sessionStorage.setItem(SESSION_TS_KEY, Date.now().toString()); } else { const prev = sessionStorage.getItem(SESSION_TS_KEY); if (!prev) sessionStorage.setItem(SESSION_TS_KEY, Date.now().toString()); } }
        function maybeExpireSession(maxIdleMs = 30 * 60 * 1000) { const last = Number(sessionStorage.getItem(SESSION_TS_KEY) || '0'); if (!last || (Date.now() - last) > maxIdleMs) { resetSession(); } sessionStorage.setItem(SESSION_TS_KEY, Date.now().toString()); }
        document.addEventListener('visibilitychange', () => { if (!document.hidden) maybeExpireSession(); });

        // --- TRANSLATION DATA ---
        const translations = {
            'en': { ai_prompt: "AI Assistant", translator_prompt: "Translator", translator_header: "Live Translator", customer_speaker: "Customer", staff_speaker: "Staff", search_placeholder: "Search for a language...", stop_btn: "Stop", select_language_title: "Select Your Language", welcome: "Welcome", first_time_title: "Is this your first time with us?", yes_btn: "Yes", no_btn: "No", our_services_title: "Our Services", our_services_subtitle: "We are a legally registered agency offering the following services:", ok_btn: "I Understand", legal_reminder_title_serious: "【Important】Disclaimer & Terms of Use", legal_reminder_text_serious: "<p><strong>1. Legal Compliance:</strong> In accordance with Japanese law, any form of payment for sexual intercourse is strictly prohibited. Our agency fully complies with all regulations.</p><p><strong>2. Client Cooperation:</strong> We require our clients' cooperation in upholding the law. Please do not request services that are illegal in Japan.</p><p><strong>3. Nature of Service:</strong> All fees are for our companion's time and pleasant company only. By proceeding, you acknowledge you are not paying for any illegal acts.</p>", legal_reminder_agreement: "By clicking 'Agree', you confirm that you have read and understood these terms.", confirm_btn: "Agree", reject_btn: "Decline", thank_you: "Thank You", rejection_text: "We appreciate your interest and hope to see you in the future. Redirecting...", welcome_back: "Welcome Back!", which_girl_title: "Do you remember your companion's name?", girl_name_placeholder: "Enter companion's name here", not_sure_btn: "I'm Not Sure", submit_continue_btn: "Submit & Continue", form_success_text: "Thank you, we've received your preference.", form_success_subtitle: "Please proceed to the legal notice.", continue_btn: "Continue", services: ["Kissing", "Handjob", "Ball Licking", "Blowjob", "Touching", "Body Licking", "69", "Massage", "Cuddling"], chat_header: "AI Assistant" },
            'ja': { ai_prompt: "AIアシスタント", translator_prompt: "翻訳者", translator_header: "ライブ翻訳", customer_speaker: "お客様", staff_speaker: "スタッフ", search_placeholder: "言語を検索...", stop_btn: "停止", select_language_title: "言語を選択してください", welcome: "ようこそ", first_time_title: "当店のご利用は初めてですか？", yes_btn: "はい", no_btn: "いいえ", our_services_title: "私たちのサービス", our_services_subtitle: "当店は合法的に登録されたエージェンシーです。以下のサービスを提供しております：", ok_btn: "確認しました", legal_reminder_title_serious: "【重要】免責事項と利用規約", legal_reminder_text_serious: "<p><strong>1. 法令遵守：</strong>日本の法律に従い、金銭による性的交渉は固く禁じられております。当店は関連法規をすべて遵守しております。</p><p><strong>2. お客様へのお願い：</strong>法律遵守のため、お客様のご協力をお願いいたします。日本で違法とされるサービスの要求はお控えください。</p><p><strong>3. サービス内容について：</strong>すべての料金は、コンパニオンとの楽しい時間と会話に対して発生するものです。これに同意することで、お客様は違法行為に対する対価を支払うものではないことを確認したものとみなされます。</p>", legal_reminder_agreement: "「同意する」をクリックすることで、上記利用規約を読み、理解したことになります。", confirm_btn: "同意する", reject_btn: "拒否する", thank_you: "ありがとうございます", rejection_text: "ご関心をお寄せいただき、誠にありがとうございます。またの機会にご利用ください。リダイレクト中です...", welcome_back: "いつもご利用ありがとうございます！", which_girl_title: "ご指名のコンパニオンはいますか？", girl_name_placeholder: "コンパニオン名を入力してください", not_sure_btn: "特に指名なし", submit_continue_btn: "送信して続行", form_success_text: "ありがとうございます。ご希望を承りました。", form_success_subtitle: "利用規約の確認へお進みください。", continue_btn: "続ける", services: ["キス", "手コキ", "玉舐め", "フェラチオ", "タッチ", "ボディ舐め", "69", "マッサージ", "添い寝"], chat_header: "AIアシスタント" },
            'zh': { ai_prompt: "AI助手", translator_prompt: "翻译员", translator_header: "实时翻译", customer_speaker: "顾客", staff_speaker: "员工", search_placeholder: "搜索语言...", stop_btn: "停止", select_language_title: "请选择您的语言", welcome: "欢迎", first_time_title: "这是您第一次光临吗？", yes_btn: "是", no_btn: "否", our_services_title: "我们的服务", our_services_subtitle: "我们是合法注册的机构，提供以下服务：", ok_btn: "我明白了", legal_reminder_title_serious: "【重要】免责声明与使用条款", legal_reminder_text_serious: "<p><strong>1. 遵守法律：</strong>根据日本法律，严禁为性交支付任何形式的报酬。本机构完全遵守所有法规。</p><p><strong>2. 客户合作：</strong>我们要求客户合作以维护法律。请不要要求在日本非法的服务。</p><p><strong>3. 服务性质：</strong>所有费用仅用于我们伴侣的时间和愉快陪伴。继续操作即表示您承认您没有为任何非法行为付费。</p>", legal_reminder_agreement: "点击“同意”，即表示您确认已阅读并理解这些条款。", confirm_btn: "同意", reject_btn: "拒绝", thank_you: "谢谢", rejection_text: "感谢您的关注。我们期待能再次为您服务。正在重定向...", welcome_back: "欢迎回来！", which_girl_title: "请问您有指定的女伴吗？", girl_name_placeholder: "请输入同伴的名字", not_sure_btn: "没有指定", submit_continue_btn: "提交并继续", form_success_text: "谢谢，我们已收到您的偏好。", form_success_subtitle: "请继续阅读法律声明。", continue_btn: "继续", services: ["接吻", "手交", "舔蛋", "口交", "触摸", "舔身体", "69", "按摩", "拥抱"], chat_header: "AI助手" },
            'ko': { ai_prompt: "AI 어시스턴트", translator_prompt: "번역가", translator_header: "실시간 번역기", customer_speaker: "고객", staff_speaker: "직원", search_placeholder: "언어 검색...", stop_btn: "중지", select_language_title: "언어를 선택하세요", welcome: "환영합니다", first_time_title: "저희는 처음 방문하시나요?", yes_btn: "예", no_btn: "아니요", our_services_title: "우리의 서비스", our_services_subtitle: "저희는 합법적으로 등록된 업체이며, 다음 서비스를 제공합니다:", ok_btn: "알겠습니다", legal_reminder_title_serious: "【중요】면책 조항 및 이용 약관", legal_reminder_text_serious: "<p><strong>1. 법률 준수:</strong> 일본 법률에 따라 성교에 대한 어떠한 형태의 지불도 엄격히 금지됩니다. 저희는 모든 규정을 완전히 준수합니다.</p><p><strong>2. 고객 협조:</strong> 법률을 준수하기 위해 고객의 협조가 필요합니다. 일본에서 불법적인 서비스를 요청하지 마십시오.</p><p><strong>3. 서비스의 성격:</strong> 모든 요금은 저희 동반자의 시간과 즐거운 교제를 위한 것입니다. 계속 진행함으로써 귀하는 불법 행위에 대해 비용을 지불하지 않음을 인정하는 것입니다.</p>", legal_reminder_agreement: "'동의'를 클릭하시면 본 약관을 읽고 이해했음을 확인하는 것입니다.", confirm_btn: "동의", reject_btn: "거절", thank_you: "감사합니다", rejection_text: "관심 가져주셔서 감사합니다. 다음에 다시 뵙기를 바랍니다. 리디렉션 중...", welcome_back: "다시 찾아주셔서 감사합니다!", which_girl_title: "지명하고 싶은 동반자가 있으신가요?", girl_name_placeholder: "동반자 이름을 입력하세요", not_sure_btn: "특별히 없음", submit_continue_btn: "제출하고 계속하기", form_success_text: "감사합니다. 귀하의 선호 사항을 접수했습니다.", form_success_subtitle: "법적 고지를 확인해 주세요.", continue_btn: "계속", services: ["키스", "핸드잡", "볼 핥기", "블로우잡", "터치", "바디 핥기", "69", "마사지", "껴안기"], chat_header: "AI 어시스턴트" },
            'es': { ai_prompt: "Asistente de IA", translator_prompt: "Traductor", translator_header: "Traductor en Vivo", customer_speaker: "Cliente", staff_speaker: "Personal", search_placeholder: "Buscar un idioma...", stop_btn: "Parar", select_language_title: "Seleccione su idioma", welcome: "Bienvenido", first_time_title: "¿Es la primera vez que nos visita?", yes_btn: "Sí", no_btn: "No", our_services_title: "Nuestros Servicios", our_services_subtitle: "Somos una agencia legalmente registrada. Ofrecemos los siguientes servicios:", ok_btn: "Entendido", legal_reminder_title_serious: "【Importante】Descargo de Responsabilidad y Términos de Uso", legal_reminder_text_serious: "<p><strong>1. Cumplimiento Legal:</strong> De acuerdo con la ley japonesa, cualquier forma de pago por relaciones sexuales está estrictamente prohibida. Nuestra agencia cumple plenamente con todas las regulaciones.</p><p><strong>2. Cooperación del Cliente:</strong> Requerimos la cooperación de nuestros clientes para cumplir la ley. Por favor, no solicite servicios que sean ilegales en Japón.</p><p><strong>3. Naturaleza del Servicio:</strong> Todas las tarifas son únicamente por el tiempo y la agradable compañía de nuestra acompañante. Al continuar, usted reconoce que no está pagando por ningún acto ilegal.</p>", legal_reminder_agreement: "Al hacer clic en 'Aceptar', confirma que ha leído y entendido estos términos.", confirm_btn: "Aceptar", reject_btn: "Rechazar", thank_you: "Gracias", rejection_text: "Agradecemos su interés y esperamos verle en el futuro. Redirigiendo...", welcome_back: "¡Bienvenido de nuevo!", which_girl_title: "¿Tiene alguna acompañante en mente?", girl_name_placeholder: "Ingrese el nombre de la acompañante", not_sure_btn: "No estoy seguro", submit_continue_btn: "Enviar y Continuar", form_success_text: "Gracias, hemos recibido su preferencia.", form_success_subtitle: "Por favor, proceda al aviso legal.", continue_btn: "Continuar", services: ["Besos", "Masturbación Manual", "Lamer Testículos", "Sexo Oral", "Tocar", "Lamer Cuerpo", "69", "Masaje", "Abrazos"], chat_header: "Asistente de IA" },
            'zh-tw': { ai_prompt: "AI助理", translator_prompt: "翻譯員", translator_header: "即時翻譯", customer_speaker: "顧客", staff_speaker: "員工", search_placeholder: "搜尋語言...", stop_btn: "停止", select_language_title: "請選擇您的語言", welcome: "歡迎", first_time_title: "這是您第一次光臨嗎？", yes_btn: "是", no_btn: "否", our_services_title: "我們的服務", our_services_subtitle: "我們是合法註冊的機構，提供以下服務：", ok_btn: "我明白了", legal_reminder_title_serious: "【重要】免責聲明與使用條款", legal_reminder_text_serious: "<p><strong>1. 遵守法律：</strong>根據日本法律，嚴禁為性交支付任何形式的報酬。本機構完全遵守所有法規。</p><p><strong>2. 客戶合作：</strong>我們要求客戶合作以維護法律。請不要要求在日本非法的服務。</p><p><strong>3. 服務性質：</strong>所有費用僅用於我們伴侶的時間和愉快陪伴。繼續操作即表示您承認您沒有為任何非法行為付費。</p>", legal_reminder_agreement: "點擊「同意」，即表示您確認已閱讀並理解這些條款。", confirm_btn: "同意", reject_btn: "拒絕", thank_you: "謝謝", rejection_text: "感謝您的關注。我們期待能再次為您服務。正在重定向...", welcome_back: "歡迎回來！", which_girl_title: "請問您有指定的女伴嗎？", girl_name_placeholder: "請輸入同伴的名字", not_sure_btn: "沒有指定", submit_continue_btn: "提交並繼續", form_success_text: "謝謝，我們已收到您的偏好。", form_success_subtitle: "請繼續閱讀法律聲明。", continue_btn: "繼續", services: ["接吻", "手交", "舔蛋", "口交", "觸摸", "舔身體", "69", "按摩", "擁抱"], chat_header: "AI助理" }
        };
        const languageOptions = [ { code: 'en', name: "English" }, { code: 'ja', name: "日本語 (Japanese)" }, { code: 'zh', name: "中文 (简体)" }, { code: 'ko', name: "한국어 (Korean)" }, { code: 'es', name: "Español (Spanish)" }, { code: 'zh-tw', name: "中文 (繁體 - 廣東話/台灣話)" } ];

        // --- UI & CORE LOGIC ---
        const aiChatMessages = document.getElementById('ai-chat-messages');
        const translationChatMessages = document.getElementById('translation-chat-messages');
        const aiConversationPanel = document.getElementById('conversation-panel');
        const translationConversationPanel = document.getElementById('translation-panel');
        const bigMicBtn = document.getElementById('big-mic');
        const translateBtn = document.getElementById('translate-btn');
        let audioContext, analyser, dataArray, source, rafId, visualizingElement = null;

        function updateText() { const langPack = translations[currentLanguage] || translations['en']; document.querySelectorAll('[data-translate-key]').forEach(el => { const key = el.getAttribute('data-translate-key'); if (langPack[key]) { if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') { el.placeholder = langPack[key]; } else { el.innerHTML = langPack[key]; } } }); populateServices(); }
        function populateLanguages(filter = '') {
            const list = document.getElementById('language-list');
            list.innerHTML = '';
            languageOptions.filter(lang => lang.name.toLowerCase().includes(filter.toLowerCase())).forEach(lang => {
                const li = document.createElement('li');
                li.textContent = lang.name;
                li.dataset.code = lang.code;
                li.className = 'px-4 py-2 hover:bg-pink-100 cursor-pointer';
                li.addEventListener('click', () => {
                    currentLanguage = lang.code;
                    document.getElementById('selected-language-name').textContent = lang.name;
                    document.getElementById('language-options').classList.add('hidden');
                    updateText();
                });
                list.appendChild(li);
            });
        }
        function populateServices() { 
            const grid = document.querySelector('#page-services .grid'); 
            if (!grid) return; 
            const services = translations[currentLanguage]?.services || translations['en'].services; 
            grid.innerHTML = ''; 
            services.forEach(service => { 
                const card = document.createElement('div'); 
                card.className = 'service-card'; 
                card.innerHTML = `<img src="https://placehold.co/400x200/fbcfe8/be185d?text=${encodeURIComponent(service)}" alt="${service}" onerror="this.onerror=null;this.src='https://placehold.co/400x200/fbcfe8/be185d?text=Service';"><p class="p-3">${service}</p>`; 
                grid.appendChild(card); 
            }); 
        }
        function showPage(pageId, isGoingBack = false) { 
            const currentPage = document.querySelector('.page-content.active'); 
            if (currentPage && !isGoingBack) pageHistory.push(currentPage.id); 
            document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active')); 
            const targetPage = document.getElementById(pageId); 
            if (targetPage) { 
                targetPage.classList.add('active'); 
                updateText(); 
            }
            const voiceControls = document.getElementById('voice-controls');
            if (pageId !== 'page-language') voiceControls.style.display = 'flex';
            else voiceControls.style.display = 'none';
        }
        function goBack() { if (pageHistory.length > 0) { const prevPageId = pageHistory.pop(); showPage(prevPageId, true); } }
        function redirectToBooking() { window.location.href = bookingUrl; }
        function handleRejection() { showPage('page-rejected'); setTimeout(() => { pageHistory = []; showPage('page-language'); }, 6000); }
        async function readResponseSafely(response) { const ct = response.headers.get('content-type') || ''; try { if (ct.includes('application/json')) return await response.json(); const text = await response.text(); return JSON.parse(text); } catch (_) { return { ok: response.ok, status: response.status }; } }
        async function sendNomination(girlName) {
            const payload = { session_id: getSessionId(), type: "nomination", payload: { girl_name: girlName, submitted_at: new Date().toISOString(), language: currentLanguage } };
            try {
                await fetch(n8nWebhookUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                showPage('page-form-success');
            } catch (error) {
                console.error('Error submitting nomination:', error);
                showPage('page-disclaimer-no');
            }
        }

        // --- DRAGGABLE LOGIC ---
        function makeDraggable(panel, header) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            header.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                panel.classList.add('dragging');
            }

            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                panel.style.bottom = 'auto';
                panel.style.right = 'auto';
                panel.style.top = (panel.offsetTop - pos2) + "px";
                panel.style.left = (panel.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                panel.classList.remove('dragging');
            }
        }
        
        // --- CONVERSATION & VOICE ---
        function closeAllPanels() {
            aiConversationPanel.style.display = 'none';
            translationConversationPanel.style.display = 'none';
        }
        function addChatMessage(message, sender, panel) { const msgDiv = document.createElement('div'); msgDiv.className = `chat-message ${sender}-message`; msgDiv.textContent = message; panel.appendChild(msgDiv); panel.scrollTop = panel.scrollHeight; return msgDiv; }
        function addTypingIndicator(panel) { const wrap = document.createElement('div'); wrap.className = 'typing'; wrap.innerHTML = `<span>.</span><span>.</span><span>.</span>`; panel.appendChild(wrap); panel.scrollTop = panel.scrollHeight; return wrap; }
        
        async function sendAudioToWebhook(audioBlob) {
            const typingEl = addTypingIndicator(aiChatMessages);
            const fd = new FormData();
            fd.append('file', audioBlob, 'voice.webm');
            fd.append('session_id', getSessionId());
            fd.append('type', 'audio_chat');
            fd.append('language', currentLanguage);
            fd.append('history', JSON.stringify(chatHistory));
            try {
                const resp = await fetch(n8nWebhookUrl, { method: 'POST', body: fd });
                const data = await readResponseSafely(resp);
                const transcribedText = data?.transcribed_text || "🎤 (Voice message received)";
                const aiResponse = data?.response || "Thank you, your message has been noted.";
                if (typingEl.parentNode) typingEl.remove();
                addChatMessage(transcribedText, 'user', aiChatMessages);
                chatHistory.push({ role: 'user', content: transcribedText });
                setTimeout(() => {
                    addChatMessage(aiResponse, 'ai', aiChatMessages);
                    chatHistory.push({ role: 'ai', content: aiResponse });
                }, 300);
            } catch (error) {
                console.error("Audio chat error:", error);
                if (typingEl.parentNode) typingEl.remove();
                addChatMessage("Sorry, an error occurred with my ears.", 'ai', aiChatMessages);
            }
        }
        async function sendAudioForTranslation(audioBlob) {
            const fd = new FormData();
            fd.append('file', audioBlob, 'voice.webm');
            fd.append('session_id', getSessionId());
            fd.append('type', `translation_${currentSpeaker}`);
            fd.append('language', currentLanguage);
            try {
                const resp = await fetch(n8nWebhookUrl, { method: 'POST', body: fd });
                const data = await readResponseSafely(resp);
                if (data.transcribed_text && data.translated_text) {
                    const originalSender = currentSpeaker === 'customer' ? 'user' : 'staff';
                    addChatMessage(data.transcribed_text, originalSender, translationChatMessages);
                    addChatMessage(`(Translated: ${data.translated_text})`, 'translation', translationChatMessages);
                }
            } catch (error) {
                console.error("Translation error:", error);
                addChatMessage("Translation failed.", "system", translationChatMessages);
            }
        }
        function visualize(stream) {
            visualizingElement = document.getElementById(currentChatMode === 'ai' ? 'big-mic' : 'translate-btn');
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            source = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            source.connect(analyser);
            const draw = () => {
                rafId = requestAnimationFrame(draw);
                if (!analyser) return;
                analyser.getByteFrequencyData(dataArray);
                const avg = dataArray.reduce((a, b) => a + b, 0) / bufferLength;
                const scaleVariation = avg / 255 * 0.2; // Creates a subtle pulse from 0 to 0.2
                if (visualizingElement) {
                    visualizingElement.style.transform = `scale(${1.1 + scaleVariation})`;
                }
            };
            draw();
        }
        async function startRecording() {
            if (isRecording) return;
            closeAllPanels();
            const panel = document.getElementById(currentChatMode === 'ai' ? 'conversation-panel' : 'translation-panel');
            panel.style.display = 'flex';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                visualize(stream);
                audioChunks = [];
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                isRecording = true;
                document.getElementById(currentChatMode === 'ai' ? 'big-mic' : 'translate-btn').classList.add('recording');
                mediaRecorder.addEventListener("dataavailable", (event) => { if (event.data?.size) audioChunks.push(event.data); });
                mediaRecorder.addEventListener("stop", () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    if(currentChatMode === 'ai') sendAudioToWebhook(audioBlob);
                    else sendAudioForTranslation(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                });
            } catch (err) { alert("Microphone access is required. Please allow access and try again."); }
        }
        function stopRecording() {
            if (!isRecording) return;
            if (mediaRecorder?.state === "recording") mediaRecorder.stop();
            isRecording = false;
            
            if (rafId) cancelAnimationFrame(rafId);
            rafId = null;
            if (source) source.disconnect();

            if (visualizingElement) {
                visualizingElement.classList.remove('recording');
                visualizingElement.style.transform = '';
                visualizingElement = null;
            } else { // Fallback in case element is lost
                document.getElementById('big-mic').classList.remove('recording');
                document.getElementById('translate-btn').classList.remove('recording');
                document.getElementById('big-mic').style.transform = '';
                document.getElementById('translate-btn').style.transform = '';
            }
        }
        async function toggleRecording() { isRecording ? stopRecording() : await startRecording(); }

        // --- INITIALIZATION ---
        function init() {
            populateLanguages();
            const langButton = document.getElementById('language-select-button');
            const langOptions = document.getElementById('language-options');
            const langSearch = document.getElementById('language-search');
            langButton.addEventListener('click', () => langOptions.classList.toggle('hidden'));
            langSearch.addEventListener('input', (e) => populateLanguages(e.target.value));
            document.addEventListener('click', (e) => {
                const container = document.getElementById('custom-language-select');
                if (container && !container.contains(e.target)) langOptions.classList.add('hidden');
            });

            showPage('page-language');
            maybeExpireSession();
            updateText();
            document.querySelectorAll('.close-panel-btn').forEach(btn => btn.addEventListener('click', closeAllPanels));
            
            document.getElementById('girl-nomination-form').addEventListener("submit", async function(event) {
                event.preventDefault();
                const girlNameInput = event.target.querySelector('input[name="girl_name"]');
                const girlName = girlNameInput.value.trim();
                if (girlName) await sendNomination(girlName);
            });
            document.getElementById('not-sure-btn').addEventListener('click', async () => await sendNomination('Not Sure'));
            
            document.getElementById('language-continue-btn').addEventListener('click', () => { 
                resetSession();
                if (document.getElementById('selected-language-name').textContent === 'Select Language') currentLanguage = 'en';
                updateText(); 
                showPage('page-first-time'); 
            });
            bigMicBtn.addEventListener('click', () => {
                currentChatMode = 'ai';
                toggleRecording();
            });
            translateBtn.addEventListener('click', () => {
                currentChatMode = 'translation';
                toggleRecording();
            });
            
            document.getElementById('speaker-customer').addEventListener('click', () => {
                currentSpeaker = 'customer';
                document.getElementById('speaker-customer').classList.add('active');
                document.getElementById('speaker-staff').classList.remove('active');
            });
            document.getElementById('speaker-staff').addEventListener('click', () => {
                currentSpeaker = 'staff';
                document.getElementById('speaker-staff').classList.add('active');
                document.getElementById('speaker-customer').classList.remove('active');
            });

            makeDraggable(document.getElementById('conversation-panel'), document.querySelector('#conversation-panel .panel-header'));
            makeDraggable(document.getElementById('translation-panel'), document.querySelector('#translation-panel .panel-header'));
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

