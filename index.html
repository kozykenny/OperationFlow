<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tokyo Girls Hub - Welcome</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <style>
    :root{
      --pink:#EC4899;
      --pink-100:#fce7f3;
      --pink-200:#fbcfe8;
      --rose-700:#be185d;
    }
    *{box-sizing:border-box}
    body {
      font-family: 'Inter', sans-serif;
      background:
        radial-gradient(60rem 60rem at 10% -10%, rgba(236,72,153,.12), transparent 40%),
        radial-gradient(70rem 70rem at 110% 10%, rgba(236,72,153,.12), transparent 40%),
        linear-gradient(135deg, #fff 0%, #fff 100%);
      color: #374151;
      min-height:100vh;
    }
    .page { display: none; }
    .page.active { display: flex; }

    /* Glass card */
    .card {
      position: relative;
      background-color: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(14px);
      border: 1px solid rgba(236, 72, 153, 0.18);
      border-radius: 1.25rem;
      padding: 2rem;
      box-shadow: 0 20px 40px -20px rgba(236, 72, 153, 0.25), 0 10px 24px -18px rgba(0,0,0,.1);
      width: 100%;
      max-width: 720px;
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .card:hover{ transform: translateY(-2px); box-shadow: 0 28px 48px -24px rgba(236,72,153,.3), 0 14px 28px -22px rgba(0,0,0,.12); }

    .btn {
      display: inline-flex; align-items:center; justify-content:center;
      gap:.5rem;
      padding: 0.9rem 1.2rem; border-radius: 0.9rem; font-weight: 600;
      transition: transform .15s ease, box-shadow .15s ease, background-color .2s ease;
      cursor: pointer; border: 1px solid transparent;
    }
    .btn:disabled { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; }
    .btn-primary { background-color: var(--pink); color: white; }
    .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(236,72,153,.35); }
    .btn-secondary { background-color: #fff; color: var(--rose-700); border-color: var(--pink-200); }
    .btn-secondary:hover { background-color: var(--pink-100); }

    .logo { font-family:"Playfair Display", serif; font-size: 2.1rem; font-weight: 700; color: var(--pink); text-align: center; margin-bottom: 0.25rem; letter-spacing:.2px; }
    .tagline { text-align:center; color:#6b7280; margin-bottom:1.25rem; }

    .grid-soft { display:grid; grid-template-columns: repeat(3,minmax(0,1fr)); gap: .9rem; }
    .service-card { background:linear-gradient(180deg,#fff,rgba(255,255,255,.9)); border:1px solid rgba(236,72,153,.2); border-radius: 0.9rem; overflow: hidden; text-align: center; color: var(--rose-700); font-weight: 500; box-shadow: 0 2px 6px rgba(0,0,0,0.04); }
    .service-card img { width: 100%; height: 100px; object-fit: cover; }
    .service-card p { padding: 0.75rem; }

    .back-button { position: absolute; top: 1rem; left: 1rem; background: white; border: 1px solid #f3f4f6; cursor: pointer; color: #6b7280; font-weight: 700; font-size: 1.2rem; line-height: 1; width:36px; height:36px; border-radius:.75rem; display:flex;align-items:center;justify-content:center; }
    .back-button:hover { color: var(--pink); border-color: var(--pink-200); }

    .legal-text { line-height: 1.7; }

    /* Conversation panel */
    #conversation-panel{
      position: fixed; right: 2rem; bottom: 2rem; width: 380px; max-width: 92vw; height: 560px;
      background: #fff; border:1px solid rgba(236,72,153,.25); border-radius:1.25rem;
      box-shadow: 0 24px 48px -24px rgba(0,0,0,.2);
      display:flex; flex-direction:column; overflow:hidden;
    }
    #panel-header{
      background: linear-gradient(90deg, var(--pink-200), #ffe4ef);
      padding: .9rem 1rem; font-weight:700; color: var(--rose-700); display:flex; align-items:center; justify-content:space-between;
    }
    #chat-messages{ flex:1; padding: 1rem; overflow-y:auto; display:flex; flex-direction:column; gap:.6rem; background: linear-gradient(180deg, #fff, #fff9fb 60%, #fff); }
    .chat-message { max-width: 84%; padding: 0.55rem 0.75rem; border-radius: 0.9rem; line-height: 1.4; font-size:.98rem; }
    .user-message { background-color: var(--pink); color: white; align-self: flex-end; border-bottom-right-radius: 0.3rem; }
    .ai-message { background-color: #f3f4f6; color: #374151; align-self: flex-start; border-bottom-left-radius: 0.3rem; }

    /* Typing indicator */
    .typing {
      align-self: flex-start;
      background-color: #f3f4f6;
      color: #374151;
      border-bottom-left-radius: 0.3rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 0.55rem 0.75rem;
      border-radius: 0.9rem;
      max-width: 84%;
    }
    .typing-dot {
      width: 6px; height: 6px; border-radius: 50%; background: #9ca3af; opacity: 0.6;
      animation: dotPulse 1.4s infinite ease-in-out;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dotPulse {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1.2); opacity: 1; }
    }

    /* Big circular mic button */
    #big-mic {
      position: fixed; left: 2rem; bottom: 2rem;
      width: 88px; height: 88px; border-radius: 9999px;
      background: var(--pink); color:#fff; border:none;
      display:flex; align-items:center; justify-content:center; cursor:pointer;
      box-shadow: 0 16px 36px -18px rgba(236,72,153,.6), 0 10px 16px -14px rgba(0,0,0,.2);
      transition: transform .12s ease, box-shadow .12s ease, background .2s ease;
      z-index: 50;
    }
    #big-mic:hover{ transform: translateY(-1px); box-shadow: 0 20px 42px -20px rgba(236,72,153,.7), 0 12px 18px -14px rgba(0,0,0,.22); }
    #big-mic.recording{ background:#f43f5e; }
    .mic-ring {
      position:absolute; inset:-8px; border-radius:9999px; border:2px solid rgba(236,72,153,.35);
      animation: ringPulse 1.6s ease-out infinite;
    }
    .mic-ring.delay { animation-delay: .35s; opacity:.6; }
    @keyframes ringPulse {
      0% { transform: scale(.9); opacity:.9; }
      100% { transform: scale(1.15); opacity:0; }
    }

    /* Voice overlay (visualizer) */
    #voice-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 60; flex-direction: column; }
    #voice-visualizer { width: 190px; height: 190px; border-radius: 50%; background-color: var(--pink);
      display: flex; align-items: center; justify-content: center; transition: transform 0.1s ease-out; box-shadow:0 20px 60px rgba(236,72,153,.45); }
    #stop-recording-btn { margin-top: 1.2rem; background: #fff; color: var(--pink); border: 2px solid var(--pink-200);
      width: 110px; height: 48px; border-radius: 9999px; font-size: .95rem; font-weight: 700; }

    /* Language select styling */
    select { appearance:none; background-image: linear-gradient(45deg, transparent 50%, var(--pink) 50%), linear-gradient(135deg, var(--pink) 50%, transparent 50%); background-position: calc(100% - 20px) calc(1em + 2px), calc(100% - 15px) calc(1em + 2px); background-size: 5px 5px, 5px 5px; background-repeat:no-repeat; }

    /* Layout helpers */
    .hero {
      max-width: 980px; margin: 2rem auto 1.25rem;
      text-align:center;
    }
    .hero h1 {
      font-family:"Playfair Display", serif;
      font-size: clamp(2rem, 2.6vw + 1rem, 3.2rem);
      color:#111827;
      line-height:1.1;
      letter-spacing:.2px;
    }
    .hero p { color:#6b7280; margin-top:.6rem; }

    @media (max-width: 1024px){
      #conversation-panel{ right: 1rem; bottom: 1rem; width: min(92vw, 420px); height: 520px; }
      #big-mic{ left: 1rem; bottom: 1rem; }
    }
  </style>
</head>
<body class="min-h-screen p-4">

  <!-- HERO / LANDING -->
  <section class="hero">
    <div class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-sm font-semibold" style="background:#fff; border:1px solid rgba(236,72,153,.25); color:#be185d;">
      <span>âœ¨ New</span> <span>Voice Assistant now available</span>
    </div>
    <h1 class="mt-3">Tokyo Girls Hub</h1>
    <p>Friendly, multilingual concierge. Ask anything hands-free â€” weâ€™ll speak your language and show the transcript.</p>
  </section>

  <div id="app-container" class="w-full flex flex-col items-center gap-6">
    <!-- Page 1: Language Selection -->
    <div id="page-language" class="page active flex-col items-center w-full">
      <div class="card w-full">
        <h2 class="logo">Tokyo Girls Hub</h2>
        <p class="tagline">Choose your language to continue</p>
        <div class="flex flex-col gap-4 max-w-md mx-auto">
          <select id="language-select" class="w-full p-3 bg-white border border-pink-200 rounded-lg focus:ring-pink-500 focus:border-pink-500 text-center"></select>
          <button id="language-continue-btn" class="btn btn-primary">
            Continue
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="m9 18 6-6-6-6"/></svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Page: First time -->
    <div id="page-first-time" class="page flex-col items-center w-full">
      <div class="card">
        <button onclick="goBack()" class="back-button">â€¹</button>
        <h2 class="logo" data-translate-key="welcome">Welcome</h2>
        <h3 class="text-2xl font-bold text-center mb-6" data-translate-key="first_time_title">Is this your first time visiting us?</h3>
        <div class="flex justify-center gap-3">
          <button onclick="showPage('page-services')" class="btn btn-primary min-w-40" data-translate-key="yes_btn">Yes</button>
          <button onclick="showPage('page-which-girl')" class="btn btn-secondary min-w-40" data-translate-key="no_btn">No</button>
        </div>
      </div>
    </div>

    <!-- Page: Services -->
    <div id="page-services" class="page flex-col items-center w-full">
      <div class="card">
        <button onclick="goBack()" class="back-button">â€¹</button>
        <h2 class="logo" data-translate-key="our_services_title">Our Services</h2>
        <p class="text-center mb-4" data-translate-key="our_services_subtitle">We are a legally registered agency. We offer the following services:</p>
        <div class="grid-soft mb-6"></div>
        <div class="text-center">
          <button onclick="showPage('page-disclaimer-yes')" class="btn btn-primary" data-translate-key="ok_btn">OK</button>
        </div>
      </div>
    </div>

    <!-- Page: Legal -->
    <div id="page-disclaimer-yes" class="page flex-col items-center w-full">
      <div class="card">
        <button onclick="goBack()" class="back-button">â€¹</button>
        <h2 class="logo text-red-500" data-translate-key="legal_reminder_title">Legal Reminder</h2>
        <div class="text-md space-y-4 mb-6 text-center legal-text" data-translate-key="legal_reminder_text"></div>
        <div class="flex justify-center gap-3">
          <button onclick="redirectToBooking()" class="btn btn-primary min-w-40" data-translate-key="confirm_btn">Confirm</button>
          <button onclick="handleRejection()" class="btn btn-secondary min-w-40" data-translate-key="reject_btn">Reject</button>
        </div>
      </div>
    </div>

    <div id="page-rejected" class="page flex-col items-center w-full">
      <div class="card text-center">
        <h2 class="logo" data-translate-key="thank_you">Thank You</h2>
        <p class="text-lg" data-translate-key="rejection_text">Thanks for your interest. We hope to see you again. Redirecting...</p>
      </div>
    </div>

    <!-- Page: Returning customer -->
    <div id="page-which-girl" class="page flex-col items-center w-full">
      <div class="card">
        <button onclick="goBack()" class="back-button">â€¹</button>
        <h2 class="logo" data-translate-key="welcome_back">Welcome Back!</h2>
        <h3 class="text-xl font-bold text-center mb-4" data-translate-key="which_girl_title">Which girl did you choose last time?</h3>
        <p class="text-center text-sm mb-6" data-translate-key="which_girl_subtitle">Let us know so we can prepare for your visit.</p>
        <form id="girl-nomination-form">
          <div class="flex flex-col gap-4">
            <input
              type="text"
              name="girl_name"
              data-translate-key="girl_name_placeholder"
              placeholder="Enter name or 'Not Sure'"
              class="w-full p-3 bg-white border border-pink-200 rounded-lg focus:ring-pink-500 focus:border-pink-500"
              required
            >
            <button type="submit" class="btn btn-primary" data-translate-key="submit_continue_btn">Submit & Continue</button>
          </div>
        </form>
      </div>
    </div>

    <div id="page-disclaimer-no" class="page flex-col items-center w-full">
      <div class="card">
        <button onclick="goBack()" class="back-button">â€¹</button>
        <h2 class="logo text-red-500" data-translate-key="legal_reminder_title">Legal Reminder</h2>
        <div class="text-md space-y-4 mb-6 text-center legal-text" data-translate-key="legal_reminder_text"></div>
        <div class="flex justify-center gap-3">
          <button onclick="redirectToBooking()" class="btn btn-primary min-w-40" data-translate-key="confirm_btn">Confirm</button>
          <button onclick="handleRejection()" class="btn btn-secondary min-w-40" data-translate-key="reject_btn">Reject</button>
        </div>
      </div>
    </div>

    <div id="page-form-success" class="page flex-col items-center w-full">
      <div class="card text-center">
        <button onclick="goBack()" class="back-button">â€¹</button>
        <h2 class="logo" data-translate-key="thank_you">Thank You!</h2>
        <p class="text-lg mb-2" data-translate-key="form_success_text">Your preference has been noted.</p>
        <p class="mb-6" data-translate-key="form_success_subtitle">Please proceed to the disclaimer.</p>
        <button onclick="showPage('page-disclaimer-no')" class="btn btn-primary" data-translate-key="continue_btn">Continue</button>
      </div>
    </div>
  </div>

  <!-- Conversation panel (transcripts + responses) -->
  <div id="conversation-panel" aria-live="polite">
    <div id="panel-header">
      <span data-translate-key="chat_header">AI Assistant</span>
      <span class="text-xs text-rose-700/80">Voice-only mode</span>
    </div>
    <div id="chat-messages"></div>
  </div>

  <!-- Big Mic Button -->
  <button id="big-mic" title="Tap to start / stop voice">
    <div class="mic-ring"></div>
    <div class="mic-ring delay"></div>
    <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line></svg>
  </button>

  <!-- Voice overlay (recording visualizer) -->
  <div id="voice-overlay">
    <div id="voice-visualizer">
      <svg xmlns="http://www.w3.org/2000/svg" width="78" height="78" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line></svg>
    </div>
    <button id="stop-recording-btn" data-translate-key="stop_btn">Stop</button>
  </div>

  <script>
    // --- CONFIGURATION ---
    const bookingUrl = 'https://tokyogirlshub.com/en/booking';
    const n8nWebhookUrl = 'https://tokyogirlshub.app.n8n.cloud/webhook/d01e21eb-14c0-41bf-8c7f-cee5a5e3371d';

    let currentLanguage = 'en';
    let pageHistory = [];
    let chatHistory = [];

    // --- SESSION ID (per-visitor memory key) ---
    const SESSION_KEY = 'tgh_session_id';
    const SESSION_TS_KEY = 'tgh_session_ts';

    function generateSessionId() {
      const buf = new Uint8Array(16);
      crypto.getRandomValues(buf);
      buf[6] = (buf[6] & 0x0f) | 0x40;
      buf[8] = (buf[8] & 0x3f) | 0x80;
      const hex = [...buf].map(b => b.toString(16).padStart(2, '0')).join('');
      return \`\${hex.slice(0,8)}-\${hex.slice(8,12)}-\${hex.slice(12,16)}-\${hex.slice(16,20)}-\${hex.slice(20)}\`;
    }

    function getSessionId() {
      let sid = sessionStorage.getItem(SESSION_KEY);
      if (!sid) {
        sid = generateSessionId();
        sessionStorage.setItem(SESSION_KEY, sid);
      }
      touchSession();
      return sid;
    }

    function resetSession() {
      sessionStorage.removeItem(SESSION_KEY);
      touchSession(true);
      return getSessionId();
    }

    function touchSession(reset = false) {
      if (reset) {
        sessionStorage.setItem(SESSION_TS_KEY, Date.now().toString());
      } else {
        const prev = sessionStorage.getItem(SESSION_TS_KEY);
        if (!prev) sessionStorage.setItem(SESSION_TS_KEY, Date.now().toString());
      }
    }

    function maybeExpireSession(maxIdleMs = 30 * 60 * 1000) {
      const last = Number(sessionStorage.getItem(SESSION_TS_KEY) || '0');
      if (!last || (Date.now() - last) > maxIdleMs) {
        resetSession();
      }
      sessionStorage.setItem(SESSION_TS_KEY, Date.now().toString());
    }

    document.addEventListener('visibilitychange', () => { if (!document.hidden) maybeExpireSession(); });

    // --- TRANSLATIONS (unchanged from your latest version) ---
    const translations = {
      'en': {
        stop_btn: "Stop",
        select_language_title: "Select Your Language",
        search_placeholder: "Search for a language...",
        welcome: "Welcome",
        first_time_title: "Is this your first time with us?",
        yes_btn: "Yes",
        no_btn: "No",
        our_services_title: "Our Services",
        our_services_subtitle: "We're a legally registered agency offering these services:",
        ok_btn: "I Understand",
        legal_reminder_title: "âš–ï¸ Legal Reminder",
        legal_reminder_text: "In Japan, paying for intercourse is strictly illegal.<br><br>We fully comply with the law, so please do not request this service.<br><br>Payment is for our companion's time and delightful company only. Thank you for your understanding!",
        confirm_btn: "I Agree",
        reject_btn: "I Decline",
        thank_you: "Thank You",
        rejection_text: "We appreciate your interest. Hope to see you again soon. Redirecting...",
        welcome_back: "Welcome Back!",
        which_girl_title: "Which companion did you see last time?",
        which_girl_subtitle: "Letting us know helps us prepare for your visit.",
        girl_name_placeholder: "Her name, or 'Not Sure'",
        submit_continue_btn: "Submit & Continue",
        confirm_booking_btn: "Confirm & Proceed to Booking",
        form_success_text: "Thank you, we've noted your preference.",
        form_success_subtitle: "Please continue to the legal reminder.",
        continue_btn: "Continue",
        services: ["Kissing", "Handjob", "Ball Licking", "Blowjob", "Touching", "Body Licking", "69", "Massage", "Cuddling"],
        back_btn: "â€¹",
        chat_header: "AI Assistant",
        chat_placeholder: "Ask a question..."
      },
      'ja': {
        stop_btn: "åœæ­¢",
        select_language_title: "è¨€èªã‚’é¸æŠã—ã¦ãã ã•ã„",
        search_placeholder: "è¨€èªã‚’æ¤œç´¢...",
        welcome: "ã‚ˆã†ã“ã",
        first_time_title: "åˆã‚ã¦ã®ã”åˆ©ç”¨ã§ã™ã‹ï¼Ÿ",
        yes_btn: "ã¯ã„",
        no_btn: "ã„ã„ãˆ",
        our_services_title: "ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹",
        our_services_subtitle: "å½“åº—ã¯åˆæ³•çš„ã«èªå¯ã•ã‚ŒãŸåº—èˆ—ã§ã™ã€‚ä»¥ä¸‹ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã”æä¾›ã—ã¦ãŠã‚Šã¾ã™ã€‚",
        ok_btn: "äº†è§£ã—ã¾ã—ãŸ",
        legal_reminder_title: "âš–ï¸ é‡è¦ãªãŠçŸ¥ã‚‰ã›",
        legal_reminder_text: "æ—¥æœ¬ã§ã¯ã€å¯¾ä¾¡ã‚’ä¼´ã†æ€§äº¤æ¸‰ã¯æ³•å¾‹ã§å›ºãç¦ã˜ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚<br><br>å½“åº—ã¯æ³•å¾‹ã‚’éµå®ˆã—ã¦ãŠã‚Šã¾ã™ã®ã§ã€ãã®ã‚ˆã†ãªã‚µãƒ¼ãƒ“ã‚¹ã®ã”è¦æ±‚ã¯ã”é æ…®ãã ã•ã„ã€‚<br><br>æ–™é‡‘ã¯ã‚ãã¾ã§ã€ã‚³ãƒ³ãƒ‘ãƒ‹ã‚ªãƒ³ã®æ™‚é–“ã¨æ¥½ã—ã„ä¼šè©±ã«å¯¾ã—ã¦ã®ã‚‚ã®ã§ã™ã€‚ã”ç†è§£ã”å”åŠ›ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚",
        confirm_btn: "åŒæ„ã—ã¾ã™",
        reject_btn: "åŒæ„ã—ã¾ã›ã‚“",
        thank_you: "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™",
        rejection_text: "ã”é–¢å¿ƒã‚’ãŠå¯„ã›ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã¾ãŸã®ã”åˆ©ç”¨ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­...",
        welcome_back: "ãŠã‹ãˆã‚Šãªã•ã„ã¾ã›ï¼",
        which_girl_title: "å‰å›ã”æŒ‡åã®ã‚³ãƒ³ãƒ‘ãƒ‹ã‚ªãƒ³ã¯ï¼Ÿ",
        which_girl_subtitle: "ãŠæ°—ã«å…¥ã‚Šã®å­ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨ã€ã‚¹ãƒ ãƒ¼ã‚ºã«ã”æ¡ˆå†…ã§ãã¾ã™ã€‚",
        girl_name_placeholder: "ã‚³ãƒ³ãƒ‘ãƒ‹ã‚ªãƒ³åã€ã¾ãŸã¯ã€Œè¦šãˆã¦ã„ãªã„ã€",
        submit_continue_btn: "é€ä¿¡ã—ã¦ç¶šã‘ã‚‹",
        confirm_booking_btn: "ç¢ºèªã—ã¦äºˆç´„ã«é€²ã‚€",
        form_success_text: "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã”å¸Œæœ›ã‚’æ‰¿ã‚Šã¾ã—ãŸã€‚",
        form_success_subtitle: "ç¶šã„ã¦ã€æ³¨æ„äº‹é …ã®ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚",
        continue_btn: "ç¶šã‘ã‚‹",
        services: ["ã‚­ã‚¹", "ãƒãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–", "ãƒœãƒ¼ãƒ«èˆã‚", "ãƒ•ã‚§ãƒ©ãƒã‚ª", "ãƒœãƒ‡ã‚£ã‚¿ãƒƒãƒ", "å…¨èº«èˆã‚", "ã‚·ãƒƒã‚¯ã‚¹ãƒŠã‚¤ãƒ³", "ãƒãƒƒã‚µãƒ¼ã‚¸", "æ·»ã„å¯"],
        back_btn: "â€¹",
        chat_header: "AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ",
        chat_placeholder: "è³ªå•ã‚’å…¥åŠ›..."
      },
      'zh': {
        stop_btn: "åœæ­¢",
        select_language_title: "è¯·é€‰æ‹©æ‚¨çš„è¯­è¨€",
        search_placeholder: "æœç´¢è¯­è¨€...",
        welcome: "æ¬¢è¿å…‰ä¸´",
        first_time_title: "æ˜¯ç¬¬ä¸€æ¬¡æ¥å—ï¼Ÿ",
        yes_btn: "æ˜¯",
        no_btn: "ä¸æ˜¯",
        our_services_title: "æœåŠ¡é¡¹ç›®",
        our_services_subtitle: "æˆ‘ä»¬æ˜¯åˆæ³•æ³¨å†Œçš„åº—é“ºï¼Œä¸ºæ‚¨æä¾›ä»¥ä¸‹æœåŠ¡é¡¹ç›®ï¼š",
        ok_btn: "æˆ‘æ˜ç™½äº†",
        legal_reminder_title: "âš–ï¸ æ³•å¾‹æé†’",
        legal_reminder_text: "åœ¨æ—¥æœ¬ï¼Œä»˜è´¹æ€§äº¤æ˜“æ˜¯ä¸¥æ ¼è¿æ³•çš„ã€‚<br><br>æˆ‘ä»¬ä¸¥æ ¼éµå®ˆæ³•å¾‹ï¼Œè¯·ä¸è¦æå‡ºæ­¤ç±»æœåŠ¡è¦æ±‚ã€‚<br><br>æ‚¨çš„è´¹ç”¨ä»…ç”¨äºå¥³ä¼´çš„å®è´µæ—¶é—´ä¸æ„‰å¿«é™ªä¼´ã€‚æ„Ÿè°¢æ‚¨çš„ç†è§£ä¸åˆä½œï¼",
        confirm_btn: "æˆ‘åŒæ„",
        reject_btn: "æˆ‘æ‹’ç»",
        thank_you: "è°¢è°¢æ‚¨",
        rejection_text: "æ„Ÿè°¢æ‚¨çš„å…‰ä¸´ï¼ŒæœŸå¾…ä¸‹æ¬¡èƒ½ä¸ºæ‚¨æœåŠ¡ã€‚é¡µé¢è·³è½¬ä¸­...",
        welcome_back: "æ¬¢è¿å›æ¥ï¼",
        which_girl_title: "ä¸Šæ¬¡æ‚¨é€‰æ‹©çš„å¥³ä¼´æ˜¯å“ªä½ï¼Ÿ",
        which_girl_subtitle: "å‘Šè¯‰æˆ‘ä»¬èƒ½å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°ä¸ºæ‚¨å‡†å¤‡ã€‚",
        girl_name_placeholder: "å¥¹çš„åå­—ï¼Œæˆ–â€œä¸ç¡®å®šâ€",
        submit_continue_btn: "æäº¤å¹¶ç»§ç»­",
        confirm_booking_btn: "ç¡®è®¤å¹¶ç»§ç»­é¢„è®¢",
        form_success_text: "è°¢è°¢ï¼Œæˆ‘ä»¬å·²è®°å½•æ‚¨çš„åå¥½ã€‚",
        form_success_subtitle: "è¯·ç»§ç»­é˜…è¯»æ³•å¾‹æé†’ã€‚",
        continue_btn: "ç»§ç»­",
        services: ["æ¥å»", "æ‰‹äº¤", "èˆ”è›‹", "å£äº¤", "è§¦æ‘¸", "èˆ”å…¨èº«", "69", "æŒ‰æ‘©", "æ‹¥æŠ±"],
        back_btn: "â€¹",
        chat_header: "AI åŠ©æ‰‹",
        chat_placeholder: "è¾“å…¥æ‚¨çš„é—®é¢˜..."
      },
      'ko': {
        stop_btn: "ì¤‘ì§€",
        select_language_title: "ì–¸ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”",
        search_placeholder: "ì–¸ì–´ ê²€ìƒ‰...",
        welcome: "ì–´ì„œ ì˜¤ì„¸ìš”",
        first_time_title: "ì²˜ìŒ ë°©ë¬¸ì´ì‹ ê°€ìš”?",
        yes_btn: "ë„¤",
        no_btn: "ì•„ë‹ˆìš”",
        our_services_title: "ì„œë¹„ìŠ¤ ì•ˆë‚´",
        our_services_subtitle: "ì €í¬ëŠ” í•©ë²•ì ìœ¼ë¡œ ë“±ë¡ëœ ì—…ì²´ì´ë©°, ë‹¤ìŒê³¼ ê°™ì€ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤:",
        ok_btn: "ì´í•´í–ˆìŠµë‹ˆë‹¤",
        legal_reminder_title: "âš–ï¸ ë²•ì  ê³ ì§€",
        legal_reminder_text: "ì¼ë³¸ì—ì„œëŠ” ê¸ˆì „ì„ ëŒ€ê°€ë¡œ í•œ ì„±ê´€ê³„ëŠ” ì—„ê²©íˆ ê¸ˆì§€ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br><br>ì €í¬ëŠ” ë²•ì„ ì¤€ìˆ˜í•˜ë¯€ë¡œ, í•´ë‹¹ ì„œë¹„ìŠ¤ ìš”ì²­ì€ ì‚¼ê°€ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.<br><br>ì§€ë¶ˆí•˜ì‹œëŠ” ë¹„ìš©ì€ ì˜¤ì§ ì»´íŒ¨ë‹ˆì–¸ì˜ ì‹œê°„ê³¼ ì¦ê±°ìš´ ëŒ€í™”ì— ëŒ€í•œ ê²ƒì…ë‹ˆë‹¤. ì´í•´ì™€ í˜‘ì¡°ì— ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.",
        confirm_btn: "ë™ì˜í•©ë‹ˆë‹¤",
        reject_btn: "ê±°ë¶€í•©ë‹ˆë‹¤",
        thank_you: "ê°ì‚¬í•©ë‹ˆë‹¤",
        rejection_text: "ê´€ì‹¬ ê°€ì ¸ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. ë‹¤ì‹œ ëµ™ê¸°ë¥¼ ë°”ëë‹ˆë‹¤. ë¦¬ë””ë ‰ì…˜ ì¤‘...",
        welcome_back: "ë‹¤ì‹œ ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!",
        which_girl_title: "ì§€ë‚œë²ˆì— ì–´ë–¤ ì»´íŒ¨ë‹ˆì–¸ê³¼ í•¨ê»˜í•˜ì…¨ë‚˜ìš”?",
        which_girl_subtitle: "ë” ë‚˜ì€ ì¤€ë¹„ë¥¼ ìœ„í•´ ì•Œë ¤ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤.",
        girl_name_placeholder: "ì´ë¦„ ë˜ëŠ” 'ì˜ ëª¨ë¥´ê² ì–´ìš”'",
        submit_continue_btn: "ì œì¶œí•˜ê³  ê³„ì†í•˜ê¸°",
        confirm_booking_btn: "í™•ì¸í•˜ê³  ì˜ˆì•½ ì§„í–‰",
        form_success_text: "ê°ì‚¬í•©ë‹ˆë‹¤, ì„ í˜¸ ì‚¬í•­ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.",
        form_success_subtitle: "ë²•ì  ê³ ì§€ ì‚¬í•­ìœ¼ë¡œ ì§„í–‰í•´ ì£¼ì„¸ìš”.",
        continue_btn: "ê³„ì†",
        services: ["í‚¤ìŠ¤", "í•¸ë“œì¡", "ë³¼ í•¥ê¸°", "ë¸”ë¡œìš°ì¡", "í„°ì¹˜", "ë°”ë”” í•¥ê¸°", "69", "ë§ˆì‚¬ì§€", "í¬ì˜¹"],
        back_btn: "â€¹",
        chat_header: "AI ì–´ì‹œìŠ¤í„´íŠ¸",
        chat_placeholder: "ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."
      },
      'es': {
        stop_btn: "Parar",
        select_language_title: "Seleccione su idioma",
        search_placeholder: "Buscar un idioma...",
        welcome: "Bienvenido",
        first_time_title: "Â¿Es su primera vez con nosotros?",
        yes_btn: "SÃ­",
        no_btn: "No",
        our_services_title: "Nuestros Servicios",
        our_services_subtitle: "Somos una agencia legalmente registrada y ofrecemos los siguientes servicios:",
        ok_btn: "Entendido",
        legal_reminder_title: "âš–ï¸ Recordatorio Legal",
        legal_reminder_text: "En JapÃ³n, pagar por relaciones sexuales estÃ¡ estrictamente prohibido por ley.<br><br>Cumplimos plenamente con la ley, por favor no solicite este servicio.<br><br>El pago es Ãºnicamente por el tiempo y la encantadora compaÃ±Ã­a de nuestras acompaÃ±antes. Â¡Gracias por su comprensiÃ³n!",
        confirm_btn: "Acepto",
        reject_btn: "Rechazo",
        thank_you: "Gracias",
        rejection_text: "Agradecemos su interÃ©s. Esperamos verle de nuevo. Redirigiendo...",
        welcome_back: "Â¡Bienvenido de nuevo!",
        which_girl_title: "Â¿QuÃ© acompaÃ±ante vio la Ãºltima vez?",
        which_girl_subtitle: "Saberlo nos ayuda a preparar su visita.",
        girl_name_placeholder: "Su nombre, o 'No estoy seguro'",
        submit_continue_btn: "Enviar y Continuar",
        confirm_booking_btn: "Confirmar y Proceder a la Reserva",
        form_success_text: "Gracias, hemos anotado su preferencia.",
        form_success_subtitle: "Por favor, continÃºe con el aviso legal.",
        continue_btn: "Continuar",
        services: ["Besos", "MasturbaciÃ³n", "Lamer testÃ­culos", "Sexo oral", "Tocar", "Lamer el cuerpo", "69", "Masaje", "Abrazos"],
        back_btn: "â€¹",
        chat_header: "Asistente de IA",
        chat_placeholder: "Haga una pregunta..."
      },
      'zh-tw': {
        stop_btn: "åœæ­¢",
        select_language_title: "è«‹é¸æ“‡æ‚¨çš„èªè¨€",
        search_placeholder: "æœå°‹èªè¨€...",
        welcome: "æ­¡è¿å…‰è‡¨",
        first_time_title: "æ˜¯ç¬¬ä¸€æ¬¡ä¾†å—ï¼Ÿ",
        yes_btn: "æ˜¯",
        no_btn: "ä¸æ˜¯",
        our_services_title: "æœå‹™é …ç›®",
        our_services_subtitle: "æˆ‘å€‘æ˜¯åˆæ³•è¨»å†Šçš„åº—å®¶ï¼Œç‚ºæ‚¨æä¾›ä»¥ä¸‹æœå‹™é …ç›®ï¼š",
        ok_btn: "æˆ‘æ˜ç™½äº†",
        legal_reminder_title: "âš–ï¸ æ³•å¾‹æé†’",
        legal_reminder_text: "åœ¨æ—¥æœ¬ï¼Œä»˜è²»æ€§äº¤æ˜“æ˜¯åš´æ ¼ç¦æ­¢çš„é•æ³•è¡Œç‚ºã€‚<br><br>æˆ‘å€‘åš´æ ¼éµå®ˆæ³•å¾‹ï¼Œè«‹ä¸è¦æå‡ºæ­¤é¡æœå‹™è¦æ±‚ã€‚<br><br>æ‚¨çš„è²»ç”¨åƒ…ç”¨æ–¼å¥³ä¼´çš„å¯¶è²´æ™‚é–“èˆ‡æ„‰å¿«é™ªä¼´ã€‚æ„Ÿè¬æ‚¨çš„ç†è§£èˆ‡åˆä½œï¼",
        confirm_btn: "æˆ‘åŒæ„",
        reject_btn: "æˆ‘æ‹’çµ•",
        thank_you: "è¬è¬æ‚¨",
        rejection_text: "æ„Ÿè¬æ‚¨çš„å…‰è‡¨ï¼ŒæœŸå¾…ä¸‹æ¬¡èƒ½ç‚ºæ‚¨æœå‹™ã€‚é é¢è·³è½‰ä¸­...",
        welcome_back: "æ­¡è¿å›ä¾†ï¼",
        which_girl_title: "ä¸Šæ¬¡æ‚¨é¸æ“‡çš„å¥³ä¼´æ˜¯å“ªä½ï¼Ÿ",
        which_girl_subtitle: "å‘Šè¨´æˆ‘å€‘èƒ½å¹«åŠ©æˆ‘å€‘æ›´å¥½åœ°ç‚ºæ‚¨æº–å‚™ã€‚",
        girl_name_placeholder: "å¥¹çš„åå­—ï¼Œæˆ–ã€Œä¸ç¢ºå®šã€",
        submit_continue_btn: "æäº¤ä¸¦ç¹¼çºŒ",
        confirm_booking_btn: "ç¢ºèªä¸¦ç¹¼çºŒé è¨‚",
        form_success_text: "è¬è¬ï¼Œæˆ‘å€‘å·²è¨˜éŒ„æ‚¨çš„åå¥½ã€‚",
        form_success_subtitle: "è«‹ç¹¼çºŒé–±è®€æ³•å¾‹æé†’ã€‚",
        continue_btn: "ç¹¼çºŒ",
        services: ["æ¥å»", "æ‰‹äº¤", "èˆ”è›‹", "å£äº¤", "è§¸æ‘¸", "èˆ”å…¨èº«", "69", "æŒ‰æ‘©", "æ“æŠ±"],
        back_btn: "â€¹",
        chat_header: "AI åŠ©ç†",
        chat_placeholder: "è¼¸å…¥æ‚¨çš„å•é¡Œ..."
      }
    };

    const languageOptions = [
      { code: 'en', name: "English" },
      { code: 'ja', name: "æ—¥æœ¬èª (Japanese)" },
      { code: 'zh', name: "ä¸­æ–‡ (ç®€ä½“)" },
      { code: 'ko', name: "í•œêµ­ì–´ (Korean)" },
      { code: 'es', name: "EspaÃ±ol (Spanish)" },
      { code: 'zh-tw', name: "ä¸­æ–‡ (ç¹é«” - å»£æ±è©±/å°ç£è©±)" }
    ];

    // --- UI + Translation helpers ---
    function updateText() {
      const langPack = translations[currentLanguage] || translations['en'];
      document.querySelectorAll('[data-translate-key]').forEach(el => {
        const key = el.getAttribute('data-translate-key');
        if (langPack[key]) {
          if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
            el.placeholder = langPack[key];
          } else {
            el.innerHTML = langPack[key];
          }
        }
      });
      populateServices();
      // header label
      const header = document.querySelector('#panel-header [data-translate-key="chat_header"]');
      if (header && langPack.chat_header) header.textContent = langPack.chat_header;
    }

    function populateLanguages() {
      const select = document.getElementById('language-select');
      select.innerHTML = '';
      languageOptions.forEach(lang => {
        const option = document.createElement('option');
        option.value = lang.code;
        option.textContent = lang.name;
        select.appendChild(option);
      });
      select.value = currentLanguage;
    }

    function populateServices() {
      const grid = document.querySelector('#page-services .grid-soft');
      const services = (translations[currentLanguage] && translations[currentLanguage].services) || translations['en'].services;
      grid.innerHTML = '';
      services.forEach(service => {
        const card = document.createElement('div');
        card.className = 'service-card';
        const imgText = encodeURIComponent(service.charAt(0));
        card.innerHTML = `<img src="https://placehold.co/400x200/fbcfe8/be185d?text=${imgText}" alt="${service}"><p>${service}</p>`;
        grid.appendChild(card);
      });
    }

    function showPage(pageId, isGoingBack = false) {
      const currentPage = document.querySelector('.page.active');
      if (currentPage && !isGoingBack) {
        pageHistory.push(currentPage.id);
      }
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      const targetPage = document.getElementById(pageId);
      if (targetPage) {
        targetPage.classList.add('active');
        updateText();
      }
    }

    function goBack() {
      if (pageHistory.length > 0) {
        const prevPageId = pageHistory.pop();
        showPage(prevPageId, true);
      }
    }

    function redirectToBooking() {
      window.location.href = bookingUrl;
    }

    function handleRejection() {
      showPage('page-rejected');
      setTimeout(() => {
        pageHistory = [];
        showPage('page-language');
      }, 6000);
    }

    // --- Network helpers ---
    async function readResponseSafely(response) {
      const ct = response.headers.get('content-type') || '';
      let text;
      try {
        if (ct.includes('application/json')) {
          return await response.json();
        }
        text = await response.text();
        return JSON.parse(text);
      } catch (_) {
        return { ok: response.ok, status: response.status, raw: text || '' };
      }
    }

    async function postJSON(payload) {
      const resp = await fetch(n8nWebhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      return readResponseSafely(resp);
    }

    // --- Form submit: nomination (unchanged behavior) ---
    document.getElementById('girl-nomination-form').addEventListener("submit", async function(event) {
      event.preventDefault();
      const girlName = new FormData(event.target).get('girl_name');
      const payload = {
        session_id: getSessionId(),
        type: "nomination",
        payload: {
          girl_name: girlName,
          submitted_at: new Date().toISOString(),
          language: currentLanguage
        }
      };
      try {
        await postJSON(payload);
        showPage('page-form-success');
      } catch (error) {
        console.error('Error submitting to webhook:', error);
        showPage('page-disclaimer-no');
      }
    });

    // --- Conversation panel (voice only) ---
    const chatMessages = document.getElementById('chat-messages');

    function addChatMessage(message, sender) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `chat-message ${sender}-message`;
      msgDiv.textContent = message;
      chatMessages.appendChild(msgDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return msgDiv;
    }

    function addTypingIndicator() {
      const wrap = document.createElement('div');
      wrap.className = 'typing';
      wrap.innerHTML = `
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
      `;
      chatMessages.appendChild(wrap);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return wrap;
    }
    function removeNode(el) { if (el && el.parentNode) el.parentNode.removeChild(el); }

    function speakText(text) {
      try {
        window.speechSynthesis.cancel();
        const uttr = new SpeechSynthesisUtterance(text);
        // Optional: set language of TTS to currentLanguage if supported
        uttr.lang = (currentLanguage === 'ja') ? 'ja-JP'
                 : (currentLanguage === 'ko') ? 'ko-KR'
                 : (currentLanguage === 'zh' || currentLanguage === 'zh-tw') ? 'zh-CN'
                 : (currentLanguage === 'es') ? 'es-ES'
                 : 'en-US';
        window.speechSynthesis.speak(uttr);
      } catch (e) { console.warn('Speech synthesis failed:', e); }
    }

    // --- Voice pipeline ---
    const bigMicBtn = document.getElementById('big-mic');
    const voiceOverlay = document.getElementById('voice-overlay');
    const stopRecordingBtn = document.getElementById('stop-recording-btn');
    const visualizer = document.getElementById('voice-visualizer');

    let mediaRecorder;
    let audioChunks = [];
    let audioContext, analyser, dataArray, source, rafId;
    let isRecording = false;

    function visualize(stream) {
      if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
      source = audioContext.createMediaStreamSource(stream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 256;
      const bufferLength = analyser.frequencyBinCount;
      dataArray = new Uint8Array(bufferLength);
      source.connect(analyser);

      const draw = () => {
        rafId = requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArray);
        const sum = dataArray.reduce((a, b) => a + b, 0);
        const avg = sum / bufferLength || 0;
        const scale = 1 + (avg / 128);
        visualizer.style.transform = `scale(${scale})`;
      };
      draw();
    }

    async function toggleRecording() {
      if (isRecording) {
        stopRecording();
      } else {
        await startRecording();
      }
    }

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        visualize(stream);
        audioChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        isRecording = true;
        bigMicBtn.classList.add('recording');
        voiceOverlay.style.display = 'flex';

        mediaRecorder.addEventListener("dataavailable", (event) => {
          if (event.data && event.data.size) audioChunks.push(event.data);
        });

        mediaRecorder.addEventListener("stop", () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          audioChunks = [];
          sendAudioToWebhook(audioBlob);
          stream.getTracks().forEach(track => track.stop());
          cancelAnimationFrame(rafId);
          visualizer.style.transform = 'scale(1)';
        });
      } catch (err) {
        console.error("Microphone error:", err);
        alert("Microphone access is required for voice chat. Please allow access and try again.");
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
      isRecording = false;
      bigMicBtn.classList.remove('recording');
      voiceOverlay.style.display = 'none';
    }

    async function sendAudioToWebhook(audioBlob) {
      const typingEl = addTypingIndicator();

      const fd = new FormData();
      fd.append('file', audioBlob, 'voice.webm');
      fd.append('session_id', getSessionId());
      fd.append('type', 'audio_chat');
      fd.append('language', currentLanguage);
      fd.append('history', JSON.stringify(chatHistory));

      try {
        const resp = await fetch(n8nWebhookUrl, { method: 'POST', body: fd });
        const data = await readResponseSafely(resp);
        // Expect: { transcribed_text: "...", response: "..." }
        const transcribedText = (data && data.transcribed_text) ? data.transcribed_text : "ğŸ¤ (Got your voice message)";
        const aiResponse = (data && data.response) ? data.response : "Thanks! Noted.";

        removeNode(typingEl);

        addChatMessage(transcribedText, 'user');
        chatHistory.push({ role: 'user', content: transcribedText });

        addChatMessage(aiResponse, 'ai');
        chatHistory.push({ role: 'ai', content: aiResponse });

        speakText(aiResponse);
      } catch (error) {
        console.error("Audio chat error:", error);
        removeNode(typingEl);
        addChatMessage("Sorry, an error occurred with my ears.", 'ai');
      }
    }

    bigMicBtn.addEventListener('click', toggleRecording);
    stopRecordingBtn.addEventListener('click', stopRecording);

    // --- Initialize app ---
    function init() {
      populateLanguages();
      showPage('page-language');
      maybeExpireSession();
      updateText();
    }

    document.getElementById('language-continue-btn').addEventListener('click', () => {
      resetSession(); // new customer = new session
      const select = document.getElementById('language-select');
      currentLanguage = select.value;
      updateText();
      showPage('page-first-time');
    });

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
