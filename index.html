<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Tokyo Girls Hub - Welcome</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root{
            --pink: #EC4899;
            --pink-100: #fce7f3;
            --pink-200: #fbcfe8;
            --rose-700: #be185d;
            --violet: #8b5cf6;
        }
        html {
            height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
            color: #374151;
            margin: 0;
            overflow-y: auto; 
            min-height: 100%;
            position: relative;
            overflow-x: hidden;
            background-color: #fce7f3; /* Fallback color */
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #fee2e2, #fef3c7, #dbeafe, #e9d5ff, #fbcfe8);
            background-size: 400% 400%;
            animation: moveGradient 45s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes moveGradient {
            0% { background-position: 100% 100%; }
            50% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        .bubbles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; 
            overflow: hidden;
            pointer-events: none;
        }
        .bubble {
            position: absolute;
            bottom: -150px;
            border-radius: 50%;
            animation: rise 25s infinite ease-in;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .bubble.circle {
             background-color: rgba(255, 255, 255, 0.35);
             box-shadow: 0 0 10px rgba(255,255,255,0.7);
        }

        .bubble.silhouette svg {
            width: 100%;
            height: 100%;
            fill: rgba(255, 255, 255, 0.3);
            filter: blur(1px);
        }


        @keyframes rise {
          0% {
            transform: translateY(0) scale(1);
            opacity: 0.7;
          }
          90% {
            opacity: 0.7;
          }
          100% {
            transform: translateY(-120vh) scale(0.3);
            opacity: 0;
          }
        }

        #app-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem 1rem;
            box-sizing: border-box;
        }

        .page-content { display: none; }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .page-content.active {
            display: flex;
            justify-content: center;
            width: 100%;
            animation: fadeInUp 0.5s ease-out forwards;
        }

        .card {
            position: relative;
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-top-color: rgba(255, 255, 255, 0.6);
            border-left-color: rgba(255, 255, 255, 0.6);
            border-radius: 1.25rem;
            padding: 2.5rem;
            box-shadow: 0 25px 45px rgba(0, 0, 0, 0.1), 0 10px 24px -18px rgba(0,0,0,.1);
            width: 100%;
            max-width: 896px;
            transition: transform .3s ease, box-shadow .3s ease;
            z-index: 1;
        }
        
        .btn {
            display: inline-flex; align-items:center; justify-content:center; gap:.5rem;
            padding: 1rem 1.75rem;
            border-radius: 0.9rem; font-weight: 600;
            transition: transform .2s ease, box-shadow .2s ease, background-color .2s ease;
            cursor: pointer; border: 1px solid transparent; text-align: center;
            position: relative;
            overflow: hidden;
        }
        .btn > * {
            position: relative;
            z-index: 2;
        }
        .btn::before {
            content: '';
            position: absolute;
            z-index: 1;
            top: 0;
            left: -150%;
            width: 50%;
            height: 100%;
            background: linear-gradient(to right, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.5) 50%, rgba(255, 255, 255, 0) 100%);
            transform: skewX(-25deg);
            animation: shine-sweep 4s infinite;
        }

        @keyframes shine-sweep {
            100% {
                left: 150%;
            }
        }
        .btn-primary { background-color: var(--pink); color: white; }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(236, 72, 153, 0.4);
        }
        .btn-secondary { background-color: #fff; color: var(--rose-700); border-color: var(--pink-200); }
        .btn-secondary:hover { background-color: var(--pink-100); }
        .btn .btn-icon { transition: transform 0.2s ease-in-out; }
        .btn:hover .btn-icon { transform: translateX(4px); }
        
        .logo { font-size: clamp(2.25rem, 5vw, 3rem); font-weight: 800; color: var(--pink); text-align: center; margin-bottom: 0.5rem; }
        .page-title { font-size: clamp(1.75rem, 4vw, 2.25rem); font-weight: 700; text-align: center; margin-bottom: 2rem; }
        
        .service-card {
            position: relative;
            overflow: hidden;
            background: linear-gradient(180deg,#fff,rgba(255,255,255,.9));
            border: 1px solid rgba(236,72,153,.2);
            border-radius: 0.9rem;
            text-align: center;
            color: var(--rose-700);
            font-weight: 600;
            font-size: 1.125rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px -5px rgba(236, 72, 153, 0.2);
        }
        .service-card img {
            height: 220px;
            width: 100%;
            object-fit: cover;
        }
        .service-card p {
            padding: 1.25rem;
        }

        .pricing-card {
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .pricing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 30px -10px rgba(236, 72, 153, 0.2);
        }
        #page-pricing .grid > div:nth-child(1) { background: linear-gradient(145deg, #fff, #fef2f2); }
        #page-pricing .grid > div:nth-child(2) { background: linear-gradient(145deg, #fff, #f5f3ff); }
        #page-pricing .grid > div:nth-child(3) { background: linear-gradient(145deg, #fff, #ecfeff); }
        
        .pricing-card .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            line-height: 1;
        }
        .pricing-card .duration {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }
        .pricing-card .price {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0.5rem 0;
            color: var(--rose-700);
        }
        .pricing-card .price .currency {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .back-button { position: absolute; top: 1rem; left: 1rem; background: white; border: 1px solid #f3f4f6; cursor: pointer; color: #6b7280; font-weight: 700; font-size: 1.2rem; line-height: 1; width:36px; height:36px; border-radius:.75rem; display:flex;align-items:center;justify-content:center; z-index: 10; }
        
        #conversation-panel, #translation-panel {
            position: fixed; right: 2rem; bottom: 10rem; width: 380px; max-width: 92vw; height: 560px;
            background: #fff; border:1px solid rgba(0,0,0,.1); border-radius:1.25rem;
            box-shadow: 0 24px 48px -24px rgba(0,0,0,.2);
            display: none; /* Initially hidden */
            flex-direction:column; z-index: 100;
            transition: width .3s ease, height .3s ease, top .3s ease, left .3s ease, right .3s ease, border-radius .3s ease;
        }
        .panel-header{ background: linear-gradient(90deg, #f3f4f6, #e5e7eb); padding: .9rem 1rem; font-weight:700; color: #374151; display:flex; align-items:center; justify-content:space-between; cursor: grab; }
        .panel-header:active { cursor: grabbing; }
        .close-panel-btn { background: none; border: none; font-size: 1.75rem; font-weight: bold; cursor: pointer; line-height: 1; color: #6b7280; opacity: 0.7; }
        .close-panel-btn:hover { opacity: 1; }
        .chat-messages{ flex:1; padding: 1rem; overflow-y:auto; display:flex; flex-direction:column; gap:.6rem; background: linear-gradient(180deg, #fff, #f9fafb 60%, #fff); }
        .chat-message { max-width: 84%; padding: 0.55rem 0.75rem; border-radius: 0.9rem; line-height: 1.4; font-size:.98rem; white-space: pre-wrap; }
        .user-message { background-color: var(--pink); color: white; align-self: flex-end; border-bottom-right-radius: 0.3rem; }
        .ai-message, .staff-message, .translation-message { background-color: #f3f4f6; color: #374151; align-self: flex-start; border-bottom-left-radius: 0.3rem; }
        .staff-message { background-color: var(--violet); color: white; }
        .translation-message { border: 1px dashed #d1d5db; color: #6b7280; font-style: italic;}
        .typing { align-self: flex-start; background-color: #f3f4f6; color: #374151; border-bottom-left-radius: 0.3rem; display: inline-flex; align-items: center; gap: 6px; padding: 0.55rem 0.75rem; border-radius: 0.9rem; max-width: 84%; }
        
        .translated-text {
            color: rgba(255, 255, 255, 0.85);
            font-style: italic;
            font-size: 0.95em;
            display: block;
            margin-top: 0.35rem;
        }
        .translation-error {
            color: #ef4444;
            font-style: italic;
            font-size: 0.9em;
            display: block;
            margin-top: 0.35rem;
        }

        .voice-control-container {
            position: fixed;
            bottom: 2rem;
            z-index: 50;
            display: none;
        }
        #voice-controls-ai { left: 2rem; }
        #voice-controls-translator { right: 2rem; }

        .control-group { 
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .control-button {
            width: 80px; height: 80px; border-radius: 9999px;
            color:#fff; border:none; position: relative;
            display:flex; align-items:center; justify-content:center; cursor:pointer;
            transition: transform .12s ease, box-shadow .12s ease, background .2s ease;
            transform-origin: center;
        }
        .control-button:hover{ transform: scale(1.05); }
        .control-prompt { 
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            color: #374151;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            white-space: nowrap;
        }
        #big-mic { background: var(--pink); }
        #translate-btn { background-color: var(--violet); }

        .record-btn {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            user-select: none;
        }
        .record-btn.recording {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.7);
        }

        .ring { position:absolute; inset:-8px; border-radius:9999px; border:2px solid; animation: ringPulse 1.6s ease-out infinite; }
        .ring.delay { animation-delay: .35s; opacity:.6; }
        @keyframes ringPulse { 0% { transform: scale(.9); opacity:.9; } 100% { transform: scale(1.15); opacity:0; } }
        
        .speaker-toggle { display: flex; background: #e5e7eb; border-radius: .75rem; padding: .25rem; }
        .speaker-toggle button { flex: 1; padding: .5rem; border-radius: .5rem; border: none; background: transparent; font-weight: 600; color: #6b7280; transition: background-color .2s ease, color .2s ease;}
        .speaker-toggle button.active.customer { background-color: var(--pink); color: white; box-shadow: 0 2px 4px rgba(236, 72, 153, 0.4); }
        .speaker-toggle button.active.staff { background-color: var(--violet); color: white; box-shadow: 0 2px 4px rgba(139, 92, 246, 0.4); }

        .custom-select-container { position: relative; }
        .custom-select-options {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid var(--pink-200); border-radius: 0.75rem;
            margin-top: 0.5rem; z-index: 100; max-height: 250px; overflow-y: auto;
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1);
        }
        
        .panel.dragging { user-select: none; transition: none !important; }

    </style>
</head>
<body>
    <div class="bubbles-container"></div>
    <div id="app-container" class="w-full flex flex-col items-center p-4">
        <div id="page-language" class="page-content active"><div class="card"><h1 class="logo">Tokyo Girls Hub</h1><h2 class="page-title" data-translate-key="select_language_title">Select Your Language</h2><div class="flex flex-col space-y-4 max-w-md mx-auto"><div id="custom-language-select" class="custom-select-container"><button id="language-select-button" type="button" class="w-full p-4 bg-white border border-pink-200 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 text-center text-lg flex justify-between items-center"><span id="selected-language-name">Select Language</span><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 3a.75.75
 0 01.53.22l3.5 3.5a.75.75 0 01-1.06 1.06L10 4.81 7.03 7.78a.75.75 0 01-1.06-1.06l3.5-3.5A.75.75 0 0110 3zm-3.72 9.53a.75.75 0 011.06 0L10 15.19l2.97-2.97a.75.75 0 111.06 1.06l-3.5 3.5a.75.75 0 01-1.06 0l-3.5-3.5a.75.75 0 010-1.06z" clip-rule="evenodd" /></svg></button><div id="language-options" class="custom-select-options hidden"><input type="text" id="language-search" class="w-full p-3 border-b border-pink-100 focus:outline-none focus:ring-1 focus:ring-pink-400" data-translate-key="search_placeholder" placeholder="Search language..."><ul id="language-list" class="py-1"></ul></div></div><button id="language-continue-btn" class="btn btn-primary text-lg" data-translate-key="continue_btn">Continue</button></div></div></div>
        <div id="page-first-time" class="page-content"><div class="card"><button onclick="goBack()" class="back-button">â€¹</button><h1 class="logo" data-translate-key="welcome">Welcome</h1><h2 class="page-title" data-translate-key="first_time_title">Is this your first time visiting us?</h2><div class="flex justify-center gap-4"><button onclick="showPage('page-services')" class="btn btn-primary w-2/5 text-lg" data-translate-key="yes_btn">Yes</button><button onclick="showPage('page-which-girl')" class="btn btn-secondary w-2/5 text-lg" data-translate-key="no_btn">No</button></div></div></div>
        <div id="page-services" class="page-content"><div class="card"><button onclick="goBack()" class="back-button">â€¹</button><h1 class="logo" data-translate-key="our_services_title">Our Services</h1><p class="text-center mb-6 text-lg" data-translate-key="our_services_subtitle">We are a legally registered agency. We offer the following services:</p><div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8"></div><div class="text-center"><button onclick="showPage('page-pricing')" class="btn btn-primary text-lg" data-translate-key="ok_btn">OK</button></div></div></div>
        
        <div id="page-pricing" class="page-content">
            <div class="card">
                <button onclick="goBack()" class="back-button">â€¹</button>
                <h1 class="logo" data-translate-key="pricing_title">Our Pricing</h1>
                <p class="text-center mb-8 text-lg text-gray-600" data-translate-key="pricing_subtitle">Simple and transparent pricing for our companionship services.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="pricing-card">
                        <div class="icon">âœ¨</div>
                        <div class="duration" data-translate-key="duration_60">60 Minutes</div>
                        <div class="price"><span class="currency">Â¥</span>30,000</div>
                    </div>
                    <div class="pricing-card">
                        <div class="icon">ğŸŒŸ</div>
                        <div class="duration" data-translate-key="duration_90">90 Minutes</div>
                        <div class="price"><span class="currency">Â¥</span>40,000</div>
                    </div>
                    <div class="pricing-card">
                        <div class="icon">ğŸ’</div>
                        <div class="duration" data-translate-key="duration_120">120 Minutes</div>
                        <div class="price"><span class="currency">Â¥</span>50,000</div>
                    </div>
                </div>
                <div class="text-center mt-8">
                    <button onclick="showPage('page-disclaimer-yes')" class="btn btn-primary text-lg" data-translate-key="continue_btn">Continue</button>
                </div>
            </div>
        </div>
        
        <div id="page-disclaimer-yes" class="page-content"><div class="card text-center"><button onclick="goBack()" class="back-button">â€¹</button><svg class="mx-auto h-16 w-16 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg><h3 class="text-2xl font-bold text-gray-800 mt-4" data-translate-key="legal_reminder_title_serious">ã€Importantã€‘Disclaimer & Terms of Use</h3><div class="mt-4 text-left space-y-3 text-gray-600 text-base" data-translate-key="legal_reminder_text_serious"></div><p class="mt-6 text-gray-800 font-semibold" data-translate-key="legal_reminder_agreement"></p><div class="flex justify-center gap-4 mt-6"><button onclick="redirectToBooking()" class="btn btn-primary w-2/5 text-lg" data-translate-key="confirm_btn">Agree</button><button onclick="handleRejection()" class="btn btn-secondary w-2/5 text-lg" data-translate-key="reject_btn">Decline</button></div></div></div>
        <div id="page-rejected" class="page-content"><div class="card text-center"><h1 class="logo" data-translate-key="thank_you">Thank You</h1><p class="text-xl" data-translate-key="rejection_text">Thanks for your interest. We hope to see you again. Redirecting...</p></div></div>
        <div id="page-which-girl" class="page-content"><div class="card"><button onclick="goBack()" class="back-button">â€¹</button><h1 class="logo" data-translate-key="welcome_back">Welcome Back!</h1><h2 class="page-title" data-translate-key="which_girl_title">Do you remember your companion's name?</h2><form id="girl-nomination-form" class="max-w-md mx-auto"><div class="flex flex-col space-y-4"><input type="text" name="girl_name" data-translate-key="girl_name_placeholder" class="w-full p-4 bg-white border border-pink-200 rounded-lg focus:ring-pink-500 focus:border-pink-500 text-lg"><button type="submit" class="btn btn-primary text-lg" data-translate-key="submit_continue_btn">Submit & Continue</button><button type="button" id="not-sure-btn" class="btn btn-secondary text-lg" data-translate-key="not_sure_btn">I'm Not Sure</button></div></form></div></div>
        <div id="page-disclaimer-no" class="page-content"><div class="card text-center"><button onclick="goBack()" class="back-button">â€¹</button><svg class="mx-auto h-16 w-16 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg><h3 class="text-2xl font-bold text-gray-800 mt-4" data-translate-key="legal_reminder_title_serious">ã€Importantã€‘Disclaimer & Terms of Use</h3><div class="mt-4 text-left space-y-3 text-gray-600 text-base" data-translate-key="legal_reminder_text_serious"></div><p class="mt-6 text-gray-800 font-semibold" data-translate-key="legal_reminder_agreement"></p><div class="flex justify-center gap-4 mt-6"><button onclick="redirectToBooking()" class="btn btn-primary w-2/5 text-lg" data-translate-key="confirm_btn">Agree</button><button onclick="handleRejection()" class="btn btn-secondary w-2/5 text-lg" data-translate-key="reject_btn">Decline</button></div></div></div>
        <div id="page-form-success" class="page-content"><div class="card text-center"><button onclick="goBack()" class="back-button">â€¹</button><h1 class="logo" data-translate-key="thank_you">Thank You!</h1><p class="text-xl mb-4" data-translate-key="form_success_text">Your preference has been noted.</p><p class="mb-6 text-lg" data-translate-key="form_success_subtitle">Please proceed to the disclaimer.</p><button onclick="showPage('page-disclaimer-no')" class="btn btn-primary text-lg" data-translate-key="continue_btn">Continue</button></div></div>
        <div id="page-post-booking" class="page-content"><div class="card text-center"><h1 class="logo" data-translate-key="thank_you">Thank You</h1><p class="text-xl mb-8" data-translate-key="post_booking_text">Your booking page is open. You can use our tools here.</p><div class="flex flex-col items-center gap-6 max-w-sm mx-auto"><button id="post-booking-ai-btn" class="btn btn-primary w-full text-2xl py-6"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line></svg><span data-translate-key="ai_prompt">AI Assistant</span></button><button id="post-booking-translator-btn" class="btn w-full text-2xl py-6" style="background-color: var(--violet); color: white;"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="m5 8 6 6"></path><path d="m4 14 6-6 2-3"></path><path d="M2 5h12"></path><path d="m7 2 3 5"></path><path d="m10 14 3-3 5 5"></path><path d="m14 11 5 5"></path><path d="M11 22h8"></path></svg><span data-translate-key="translator_prompt">Translator</span></button></div><div class="flex justify-center gap-4 mt-8"><button onclick="goBack()" class="btn btn-secondary text-lg" data-translate-key="go_back_btn">Go Back</button><button onclick="startOver()" class="btn btn-secondary text-lg" data-translate-key="start_over_btn">Start Over</button></div></div></div>
    </div>

    <div id="conversation-panel" class="panel"><div id="ai-panel-header" class="panel-header"><span data-translate-key="chat_header">AI Assistant</span><button class="close-panel-btn" title="Close panel">&times;</button></div><div id="ai-chat-messages" class="chat-messages"></div><div class="p-4 border-t border-gray-200"><button id="ai-mic-btn" class="w-full btn btn-primary record-btn" data-translate-key="hold_to_speak">Speak</button></div></div>
    
    <div id="translation-panel" class="panel">
        <div id="translation-panel-header" class="panel-header"><span data-translate-key="translator_header">Live Translator</span><button class="close-panel-btn" title="Close panel">&times;</button></div>
        <div id="translation-chat-messages" class="chat-messages"></div>
        <div class="p-4 border-t border-gray-200">
            <div class="speaker-toggle mb-4">
                <button id="speaker-customer" data-translate-key="customer_speaker">Customer</button>
                <button id="speaker-staff" data-translate-key="staff_speaker">Staff</button>
            </div>
            <button id="translation-mic-btn" class="w-full btn record-btn" data-translate-key="hold_to_speak">Speak</button>
        </div>
    </div>

    <div id="voice-controls-ai" class="voice-control-container">
        <div class="control-group">
            <button id="big-mic" title="AI Assistant" class="control-button"><div class="ring" style="border-color: var(--pink);"></div><div class="ring delay" style="border-color: var(--pink);"></div><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line></svg></button>
            <p class="control-prompt" data-translate-key="ai_prompt">AI Assistant</p>
        </div>
    </div>

    <div id="voice-controls-translator" class="voice-control-container">
        <div class="control-group">
             <p class="control-prompt" data-translate-key="translator_prompt">Translator</p>
            <button id="translate-btn" title="Translator" class="control-button"><div class="ring" style="border-color: var(--violet);"></div><div class="ring delay" style="border-color: var(--violet);"></div><svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="m7 2 3 5"/><path d="m10 14 3-3 5 5"/><path d="m14 11 5 5"/><path d="M11 22h8"/></svg></button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const n8nWebhookUrl = 'https://tokyogirlshub.app.n8n.cloud/webhook/d01e21eb-14c0-41bf-8c7f-cee5a5e3371d';
        let currentLanguage = 'en';
        let pageHistory = [];
        let chatHistory = [];
        let currentChatMode = 'ai'; // 'ai' or 'translation'
        let currentSpeaker = 'customer'; // 'customer' or 'staff'
        let mediaRecorder, audioChunks = [], isRecording = false;
        let activeMicBtn = null;

        // --- SESSION MANAGEMENT ---
        const SESSION_KEY = 'tgh_session_id'; const SESSION_TS_KEY = 'tgh_session_ts';
        function generateSessionId() { const buf = new Uint8Array(16); crypto.getRandomValues(buf); buf[6] = (buf[6] & 0x0f) | 0x40; buf[8] = (buf[8] & 0x3f) | 0x80; const hex = [...buf].map(b => b.toString(16).padStart(2, '0')).join(''); return `${hex.slice(0,8)}-${hex.slice(8,12)}-${hex.slice(12,16)}-${hex.slice(16,20)}-${hex.slice(20)}`; }
        function getSessionId() { let sid = sessionStorage.getItem(SESSION_KEY); if (!sid) { sid = generateSessionId(); sessionStorage.setItem(SESSION_KEY, sid); } touchSession(); return sid; }
        function resetSession() { sessionStorage.removeItem(SESSION_KEY); touchSession(true); return getSessionId(); }
        function touchSession(reset = false) { if (reset) { sessionStorage.setItem(SESSION_TS_KEY, Date.now().toString()); } else { const prev = sessionStorage.getItem(SESSION_TS_KEY); if (!prev) sessionStorage.setItem(SESSION_TS_KEY, Date.now().toString()); } }
        function maybeExpireSession(maxIdleMs = 30 * 60 * 1000) { const last = Number(sessionStorage.getItem(SESSION_TS_KEY) || '0'); if (!last || (Date.now() - last) > maxIdleMs) { resetSession(); } sessionStorage.setItem(SESSION_TS_KEY, Date.now().toString()); }
        document.addEventListener('visibilitychange', () => { if (!document.hidden) maybeExpireSession(); });

        // --- TRANSLATION DATA ---
        const translations = {
            'en': { 
                go_back_btn: "Go Back", start_over_btn: "Start Over",
                post_booking_text: "Your booking page is open. You can use our tools here.",
                ai_prompt: "AI Assistant", translator_prompt: "Translator", translator_header: "Live Translator", customer_speaker: "Customer", staff_speaker: "Staff", hold_to_speak: "Speak", search_placeholder: "Search for a language...", stop_btn: "Stop", select_language_title: "Select Your Language", 
                welcome: "Welcome", first_time_title: "Is this your first time with us?", yes_btn: "Yes", no_btn: "No", 
                our_services_title: "Our Services", our_services_subtitle: "We are a legally registered agency offering the following services:", ok_btn: "View Pricing", 
                pricing_title: "Our Pricing", pricing_subtitle: "Simple and transparent pricing for our companionship services.", 
                duration_60: "60 Minutes", duration_90: "90 Minutes", duration_120: "120 Minutes",
                legal_reminder_title_serious: "ã€Importantã€‘Disclaimer & Terms of Use", 
                legal_reminder_text_serious: "<p><strong>1. Legal Compliance:</strong> In accordance with Japanese law, any form of payment for sexual intercourse is strictly prohibited. Our agency fully complies with all regulations.</p><p><strong>2. Client Cooperation:</strong> We require our clients' cooperation in upholding the law. Please do not request services that are illegal in Japan.</p><p><strong>3. Nature of Service:</strong> All fees are for our companion's time and pleasant company only. By proceeding, you acknowledge you are not paying for any illegal acts.</p>", 
                legal_reminder_agreement: "By clicking 'Agree', you confirm that you have read and understood these terms.", 
                confirm_btn: "Agree", reject_btn: "Decline", thank_you: "Thank You", rejection_text: "We appreciate your interest and hope to see you in the future. Redirecting...", 
                welcome_back: "Welcome Back!", which_girl_title: "Do you remember your companion's name?", girl_name_placeholder: "Enter companion's name here", 
                not_sure_btn: "I'm Not Sure", submit_continue_btn: "Submit & Continue", form_success_text: "Thank you, we've received your preference.", 
                form_success_subtitle: "Please proceed to the legal notice.", continue_btn: "Continue", 
                services: ["Kissing", "Handjob", "Ball Licking", "Blowjob", "Touching", "Body Licking", "69", "Oral", "Cuddling", "Add-Ons (extra charge)"], 
                chat_header: "AI Assistant", error_speak_again: "An error occurred. Please speak into the mic again." 
            },
            'ja': { 
                go_back_btn: "æˆ»ã‚‹", start_over_btn: "æœ€åˆã‹ã‚‰",
                post_booking_text: "äºˆç´„ãƒšãƒ¼ã‚¸ãŒé–‹ãã¾ã—ãŸã€‚ã“ã¡ã‚‰ã§ãƒ„ãƒ¼ãƒ«ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚",
                ai_prompt: "AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ",  translator_prompt: "ç¿»è¨³è€…", translator_header: "ãƒ©ã‚¤ãƒ–ç¿»è¨³", customer_speaker: "ãŠå®¢æ§˜", staff_speaker: "ã‚¹ã‚¿ãƒƒãƒ•", hold_to_speak: "è©±ã™", search_placeholder: "è¨€èªã‚’æ¤œç´¢...", stop_btn: "åœæ­¢", select_language_title: "è¨€èªã‚’é¸æŠã—ã¦ãã ã•ã„", 
                welcome: "ã‚ˆã†ã“ã", first_time_title: "å½“åº—ã®ã”åˆ©ç”¨ã¯åˆã‚ã¦ã§ã™ã‹ï¼Ÿ", yes_btn: "ã¯ã„", no_btn: "ã„ã„ãˆ", 
                our_services_title: "ç§ãŸã¡ã®ã‚µãƒ¼ãƒ“ã‚¹", our_services_subtitle: "å½“åº—ã¯åˆæ³•çš„ã«ç™»éŒ²ã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ã‚·ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã—ã¦ãŠã‚Šã¾ã™ï¼š", ok_btn: "æ–™é‡‘ã‚’è¦‹ã‚‹", 
                pricing_title: "æ–™é‡‘ãƒ—ãƒ©ãƒ³", pricing_subtitle: "æ˜ç¢ºã§ã‚·ãƒ³ãƒ—ãƒ«ãªã‚³ãƒ³ãƒ‘ãƒ‹ã‚ªãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã®æ–™é‡‘ãƒ—ãƒ©ãƒ³ã§ã™ã€‚",
                duration_60: "60åˆ†", duration_90: "90åˆ†", duration_120: "120åˆ†",
                legal_reminder_title_serious: "ã€é‡è¦ã€‘å…è²¬äº‹é …ã¨åˆ©ç”¨è¦ç´„", 
                legal_reminder_text_serious: "<p><strong>1. æ³•ä»¤éµå®ˆï¼š</strong>æ—¥æœ¬ã®æ³•å¾‹ã«å¾“ã„ã€é‡‘éŠ­ã«ã‚ˆã‚‹æ€§çš„äº¤æ¸‰ã¯å›ºãç¦ã˜ã‚‰ã‚Œã¦ãŠã‚Šã¾ã™ã€‚å½“åº—ã¯é–¢é€£æ³•è¦ã‚’ã™ã¹ã¦éµå®ˆã—ã¦ãŠã‚Šã¾ã™ã€‚</p><p><strong>2. ãŠå®¢æ§˜ã¸ã®ãŠé¡˜ã„ï¼š</strong>æ³•å¾‹éµå®ˆã®ãŸã‚ã€ãŠå®¢æ§˜ã®ã”å”åŠ›ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚æ—¥æœ¬ã§é•æ³•ã¨ã•ã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®è¦æ±‚ã¯ãŠæ§ãˆãã ã•ã„ã€‚</p><p><strong>3. ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹ã«ã¤ã„ã¦ï¼š</strong>ã™ã¹ã¦ã®æ–™é‡‘ã¯ã€ã‚³ãƒ³ãƒ‘ãƒ‹ã‚ªãƒ³ã¨ã®æ¥½ã—ã„æ™‚é–“ã¨ä¼šè©±ã«å¯¾ã—ã¦ç™ºç”Ÿã™ã‚‹ã‚‚ã®ã§ã™ã€‚ã“ã‚Œã«åŒæ„ã™ã‚‹ã“ã¨ã§ã€ãŠå®¢æ§˜ã¯é•æ³•è¡Œç‚ºã«å¯¾ã™ã‚‹å¯¾ä¾¡ã‚’æ”¯æ‰•ã†ã‚‚ã®ã§ã¯ãªã„ã“ã¨ã‚’ç¢ºèªã—ãŸã‚‚ã®ã¨ã¿ãªã•ã‚Œã¾ã™ã€‚</p>", 
                legal_reminder_agreement: "ã€ŒåŒæ„ã™ã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã“ã¨ã§ã€ä¸Šè¨˜åˆ©ç”¨è¦ç´„ã‚’èª­ã¿ã€ç†è§£ã—ãŸã“ã¨ã«ãªã‚Šã¾ã™ã€‚", 
                confirm_btn: "åŒæ„ã™ã‚‹", reject_btn: "æ‹’å¦ã™ã‚‹", thank_you: "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™", rejection_text: "ã”é–¢å¿ƒã‚’ãŠå¯„ã›ã„ãŸã ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã¾ãŸã®æ©Ÿä¼šã«ã”åˆ©ç”¨ãã ã•ã„ã€‚ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­ã§ã™...", 
                welcome_back: "ã„ã¤ã‚‚ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼", which_girl_title: "ã”æŒ‡åã®ã‚³ãƒ³ãƒ‘ãƒ‹ã‚ªãƒ³ã¯ã„ã¾ã™ã‹ï¼Ÿ", girl_name_placeholder: "ã‚³ãƒ³ãƒ‘ãƒ‹ã‚ªãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", 
                not_sure_btn: "ç‰¹ã«æŒ‡åãªã—", submit_continue_btn: "é€ä¿¡ã—ã¦ç¶šè¡Œ", form_success_text: "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã”å¸Œæœ›ã‚’æ‰¿ã‚Šã¾ã—ãŸã€‚", 
                form_success_subtitle: "åˆ©ç”¨è¦ç´„ã®ç¢ºèªã¸ãŠé€²ã¿ãã ã•ã„ã€‚", continue_btn: "ç¶šã‘ã‚‹", 
                services: ["ã‚­ã‚¹", "æ‰‹ã‚³ã‚­", "ç‰èˆã‚", "ãƒ•ã‚§ãƒ©ãƒã‚ª", "ã‚¿ãƒƒãƒ", "ãƒœãƒ‡ã‚£èˆã‚", "69", "ã‚ªãƒ¼ãƒ©ãƒ«", "æ·»ã„å¯", "è¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆåˆ¥æ–™é‡‘ï¼‰"], 
                chat_header: "AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ", error_speak_again: "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãƒã‚¤ã‚¯ã«å‘ã‹ã£ã¦ãŠè©±ã—ãã ã•ã„ã€‚" 
            },
            'zh': { 
                go_back_btn: "è¿”å›", start_over_btn: "é‡æ–°å¼€å§‹",
                post_booking_text: "æ‚¨çš„é¢„è®¢é¡µé¢å·²æ‰“å¼€ã€‚æ‚¨å¯ä»¥åœ¨æ­¤å¤„ä½¿ç”¨æˆ‘ä»¬çš„å·¥å…·ã€‚",
                ai_prompt: "AIåŠ©æ‰‹", translator_prompt: "ç¿»è¯‘å‘˜", translator_header: "å®æ—¶ç¿»è¯‘", customer_speaker: "é¡¾å®¢", staff_speaker: "å‘˜å·¥", hold_to_speak: "è¯´è¯", search_placeholder: "æœç´¢è¯­è¨€...", stop_btn: "åœæ­¢", select_language_title: "è¯·é€‰æ‹©æ‚¨çš„è¯­è¨€", 
                welcome: "æ¬¢è¿", first_time_title: "è¿™æ˜¯æ‚¨ç¬¬ä¸€æ¬¡å…‰ä¸´å—ï¼Ÿ", yes_btn: "æ˜¯", no_btn: "å¦", 
                our_services_title: "æˆ‘ä»¬çš„æœåŠ¡", our_services_subtitle: "æˆ‘ä»¬æ˜¯åˆæ³•æ³¨å†Œçš„æœºæ„ï¼Œæä¾›ä»¥ä¸‹æœåŠ¡ï¼š", ok_btn: "æŸ¥çœ‹ä»·æ ¼", 
                pricing_title: "æˆ‘ä»¬çš„ä»·æ ¼", pricing_subtitle: "æˆ‘ä»¬ä¼´æ¸¸æœåŠ¡çš„ä»·æ ¼ç®€å•é€æ˜ã€‚",
                duration_60: "60åˆ†é’Ÿ", duration_90: "90åˆ†é’Ÿ", duration_120: "120åˆ†é’Ÿ",
                legal_reminder_title_serious: "ã€é‡è¦ã€‘å…è²¬å£°æ˜ä¸ä½¿ç”¨æ¡æ¬¾", 
                legal_reminder_text_serious: "<p><strong>1. éµå®ˆæ³•å¾‹ï¼š</strong>æ ¹æ®æ—¥æœ¬æ³•å¾‹ï¼Œä¸¥ç¦ä¸ºæ€§äº¤æ”¯ä»˜ä»»ä½•å½¢å¼çš„æŠ¥é…¬ã€‚æœ¬æœºæ„å®Œå…¨éµå®ˆæ‰€æœ‰æ³•è§„ã€‚</p><p><strong>2. å®¢æˆ·åˆä½œï¼š</strong>æˆ‘ä»¬è¦æ±‚å®¢æˆ·åˆä½œä»¥ç»´æŠ¤æ³•å¾‹ã€‚è¯·ä¸è¦è¦æ±‚åœ¨æ—¥æœ¬éæ³•çš„æœåŠ¡ã€‚</p><p><strong>3. æœåŠ¡æ€§è´¨ï¼š</strong>æ‰€æœ‰è´¹ç”¨ä»…ç”¨äºæˆ‘ä»¬ä¼´ä¾£çš„æ—¶é—´å’Œæ„‰å¿«é™ªä¼´ã€‚åŒæ„è¿™ä¸€ç‚¹ï¼Œå³è¡¨ç¤ºæ‚¨ç¡®è®¤æ‚¨æ”¯ä»˜çš„è´¹ç”¨å¹¶éç”¨äºä»»ä½•éæ³•è¡Œä¸ºã€‚</p>",
                legal_reminder_agreement: "ç‚¹å‡»â€œåŒæ„â€ï¼Œå³è¡¨ç¤ºæ‚¨ç¡®è®¤å·²é˜…è¯»å¹¶ç†è§£è¿™äº›æ¡æ¬¾ã€‚", 
                confirm_btn: "åŒæ„", reject_btn: "æ‹’ç»", thank_you: "è°¢è°¢", rejection_text: "æ„Ÿè°¢æ‚¨çš„å…³æ³¨ã€‚æˆ‘ä»¬æœŸå¾…èƒ½å†æ¬¡ä¸ºæ‚¨æœåŠ¡ã€‚æ­£åœ¨é‡å®šå‘...", 
                welcome_back: "æ¬¢è¿å›æ¥ï¼", which_girl_title: "è¯·é—®æ‚¨æœ‰æŒ‡å®šçš„å¥³ä¼´å—ï¼Ÿ", girl_name_placeholder: "è¯·è¾“å…¥åŒä¼´çš„åå­—", 
                not_sure_btn: "æ²¡æœ‰æŒ‡å®š", submit_continue_btn: "æäº¤å¹¶ç»§ç»­", form_success_text: "è°¢è°¢ï¼Œæˆ‘ä»¬å·²æ”¶åˆ°æ‚¨çš„åå¥½ã€‚", 
                form_success_subtitle: "è¯·ç»§ç»­é˜…è¯»æ³•å¾‹å£°æ˜ã€‚", continue_btn: "ç»§ç»­", 
                services: ["æ¥å»", "æ‰‹äº¤", "èˆ”è›‹", "å£äº¤", "è§¦æ‘¸", "èˆ”èº«ä½“", "69", "å£éƒ¨æœåŠ¡", "æ‹¥æŠ±", "é™„åŠ é¡¹ç›®ï¼ˆé¢å¤–æ”¶è´¹ï¼‰"], 
                chat_header: "AIåŠ©æ‰‹", error_speak_again: "å‘ç”Ÿé”™è¯¯ï¼Œè¯·å†å¯¹éº¦å…‹é£è¯´ä¸€æ¬¡ã€‚" 
            },
            'ko': { 
                go_back_btn: "ë’¤ë¡œê°€ê¸°", start_over_btn: "ì²˜ìŒë¶€í„°",
                post_booking_text: "ì˜ˆì•½ í˜ì´ì§€ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤. ì—¬ê¸°ì—ì„œ ë„êµ¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                ai_prompt: "AI ì–´ì‹œìŠ¤í„´íŠ¸", translator_prompt: "ë²ˆì—­ê°€", translator_header: "ì‹¤ì‹œê°„ ë²ˆì—­ê¸°", customer_speaker: "ê³ ê°", staff_speaker: "ì§ì›", hold_to_speak: "ë§í•˜ê¸°", search_placeholder: "ì–¸ì–´ ê²€ìƒ‰...", stop_btn: "ì¤‘ì§€", select_language_title: "ì–¸ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”", 
                welcome: "í™˜ì˜í•©ë‹ˆë‹¤", first_time_title: "ì €í¬ëŠ” ì²˜ìŒ ë°©ë¬¸í•˜ì‹œë‚˜ìš”?", yes_btn: "ì˜ˆ", no_btn: "ì•„ë‹ˆìš”", 
                our_services_title: "ìš°ë¦¬ì˜ ì„œë¹„ìŠ¤", our_services_subtitle: "ì €í¬ëŠ” í•©ë²•ì ìœ¼ë¡œ ë“±ë¡ëœ ì—…ì²´ì´ë©°, ë‹¤ìŒ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤:", ok_btn: "ê°€ê²© ë³´ê¸°", 
                pricing_title: "ìš”ê¸ˆ ì•ˆë‚´", pricing_subtitle: "ê°„ë‹¨í•˜ê³  íˆ¬ëª…í•œ ì €í¬ ë™ë°˜ ì„œë¹„ìŠ¤ ìš”ê¸ˆì…ë‹ˆë‹¤ã€‚",
                duration_60: "60ë¶„", duration_90: "90ë¶„", duration_120: "120ë¶„",
                legal_reminder_title_serious: "ã€ì¤‘ìš”ã€‘ë©´ì±… ì¡°í•­ ë° ì´ìš© ì•½ê´€", 
                legal_reminder_text_serious: "<p><strong>1. ë²•ë¥  ì¤€ìˆ˜:</strong> ì¼ë³¸ ë²•ë¥ ì— ë”°ë¼ ì„±êµì— ëŒ€í•œ ì–´ë– í•œ í˜•íƒœì˜ ì§€ë¶ˆë„ ì—„ê²©íˆ ê¸ˆì§€ë©ë‹ˆë‹¤. ì €í¬ëŠ” ëª¨ë“  ê·œì •ì„ ì™„ì „íˆ ì¤€ìˆ˜í•©ë‹ˆë‹¤ã€‚</p><p><strong>2. ê³ ê° í˜‘ì¡°:</strong> ë²•ë¥ ì„ ì¤€ìˆ˜í•˜ê¸° ìœ„í•´ ê³ ê°ì˜ í˜‘ì¡°ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì¼ë³¸ì—ì„œ ë¶ˆë²•ì ì¸ ì„œë¹„ìŠ¤ë¥¼ ìš”ì²­í•˜ì§€ ë§ˆì‹­ì‹œì˜¤ã€‚</p><p><strong>3. ì„œë¹„ìŠ¤ì˜ ì„±ê²©:</strong> ëª¨ë“  ìš”ê¸ˆì€ ë™ë°˜ìì™€ì˜ ì¦ê±°ìš´ ì‹œê°„ê³¼ êµì œë¥¼ ìœ„í•œ ê²ƒì…ë‹ˆë‹¤. ì´ì— ë™ì˜í•¨ìœ¼ë¡œì¨ ê·€í•˜ëŠ” ë¶ˆë²• í–‰ìœ„ì— ëŒ€í•œ ë¹„ìš©ì„ ì§€ë¶ˆí•˜ëŠ” ê²ƒì´ ì•„ë‹˜ì„ í™•ì¸í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤ã€‚</p>",
                legal_reminder_agreement: "'ë™ì˜'ë¥¼ í´ë¦­í•˜ì‹œë©´ ë³¸ ì•½ê´€ì„ ì½ê³  ì´í•´í–ˆìŒì„ í™•ì¸í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤ã€‚", 
                confirm_btn: "ë™ì˜", reject_btn: "ê±°ì ˆ", thank_you: "ê°ì‚¬í•©ë‹ˆë‹¤", rejection_text: "ê´€ì‹¬ ê°€ì ¸ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. ë‹¤ìŒì— ë‹¤ì‹œ ëµ™ê¸°ë¥¼ ë°”ëë‹ˆë‹¤. ë¦¬ë””ë ‰ì…˜ ì¤‘...", 
                welcome_back: "ë‹¤ì‹œ ì°¾ì•„ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!", which_girl_title: "ì§€ëª…í•˜ê³  ì‹¶ì€ ë™ë°˜ìê°€ ìˆìœ¼ì‹ ê°€ìš”?", girl_name_placeholder: "ë™ë°˜ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", 
                not_sure_btn: "íŠ¹ë³„íˆ ì—†ìŒ", submit_continue_btn: "ì œì¶œí•˜ê³  ê³„ì†í•˜ê¸°", form_success_text: "ê°ì‚¬í•©ë‹ˆë‹¤. ê·€í•˜ì˜ ì„ í˜¸ ì‚¬í•­ì„ ì ‘ìˆ˜í–ˆìŠµë‹ˆë‹¤.", 
                form_success_subtitle: "ë²•ì  ê³ ì§€ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.", continue_btn: "ê³„ì†", 
                services: ["í‚¤ìŠ¤", "í•¸ë“œì¡", "ë³¼ í•¥ê¸°", "ë¸”ë¡œìš°ì¡", "í„°ì¹˜", "ë°”ë”” í•¥ê¸°", "69", "ì˜¤ë„", "ê»´ì•ˆê¸°", "ì¶”ê°€ ì˜µì…˜ (ì¶”ê°€ ìš”ê¸ˆ)"], 
                chat_header: "AI ì–´ì‹œìŠ¤í„´íŠ¸", error_speak_again: "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë§ˆì´í¬ì— ë‹¤ì‹œ ë§ì”€í•´ì£¼ì„¸ìš”ã€‚" 
            },
            'es': { 
                go_back_btn: "Volver", start_over_btn: "Empezar de Nuevo",
                post_booking_text: "Su pÃ¡gina de reserva estÃ¡ abierta. Puede utilizar nuestras herramientas aquÃ­.",
                ai_prompt: "Asistente de IA", translator_prompt: "Traductor", translator_header: "Traductor en Vivo", customer_speaker: "Cliente", staff_speaker: "Personal", hold_to_speak: "Hablar", search_placeholder: "Buscar un idioma...", stop_btn: "Parar", select_language_title: "Seleccione su idioma", 
                welcome: "Bienvenido", first_time_title: "Â¿Es la primera vez que nos visita?", yes_btn: "SÃ­", no_btn: "No", 
                our_services_title: "Nuestros Servicios", our_services_subtitle: "Somos una agencia legalmente registrada. Ofrecemos los siguientes servicios:", ok_btn: "Ver Precios", 
                pricing_title: "Nuestros Precios", pricing_subtitle: "Precios simples y transparentes para nuestros servicios de acompaÃ±amiento.",
                duration_60: "60 Minutos", duration_90: "90 Minutos", duration_120: "120 Minutos",
                legal_reminder_title_serious: "ã€Importanteã€‘Descargo de Responsabilidad y TÃ©rminos de Uso", 
                legal_reminder_text_serious: "<p><strong>1. Cumplimiento Legal:</strong> De acuerdo con la ley japonesa, cualquier forma de pago por relaciones sexuales estÃ¡ prohibido. Nuestra agencia cumple plenamente con todas las regulaciones.</p><p><strong>2. CooperaciÃ³n del Cliente:</strong> Requerimos la cooperaciÃ³n de nuestros clientes para cumplir la ley. Por favor, no solicite servicios que sean ilegales en JapÃ³n.</p><p><strong>3. Naturaleza del Servicio:</strong> Todas las tarifas son Ãºnicamente por el tiempo y la agradable compaÃ±Ã­a de nuestra acompaÃ±ante. Al continuar, usted reconoce que no estÃ¡ pagando por ningÃºn acto ilegal.</p>", 
                legal_reminder_agreement: "Al hacer clic en 'Aceptar', confirma que ha leÃ­do y entendido estos tÃ©rminos.", 
                confirm_btn: "Aceptar", reject_btn: "Rechazar", thank_you: "Gracias", rejection_text: "Agradecemos su interÃ©s y esperamos verle en el futuro. Redirigiendo...", 
                welcome_back: "Â¡Bienvenido de nuevo!", which_girl_title: "Â¿Tiene alguna acompaÃ±ante en mente?", girl_name_placeholder: "Ingrese el nombre de la acompaÃ±ante", 
                not_sure_btn: "No estoy seguro", submit_continue_btn: "Enviar y Continuar", form_success_text: "Gracias, hemos recibido su preferencia.", 
                form_success_subtitle: "Por favor, proceda al aviso legal.", continue_btn: "Continuar", 
                services: ["Besos", "MasturbaciÃ³n Manual", "Lamer TestÃ­culos", "Sexo Oral", "Tocar", "Lamer Cuerpo", "69", "Oral", "Abrazos", "Servicios Adicionales (cargo extra)"], 
                chat_header: "Asistente de IA", error_speak_again: "OcurriÃ³ un error. Por favor, hable de nuevo al micrÃ³fono." 
            },
            'zh-tw': { 
                go_back_btn: "è¿”å›", start_over_btn: "é‡æ–°é–‹å§‹",
                post_booking_text: "æ‚¨çš„é è¨‚é é¢å·²æ‰“é–‹ã€‚æ‚¨å¯ä»¥åœ¨æ­¤è™•ä½¿ç”¨æˆ‘å€‘çš„å·¥å…·ã€‚",
                ai_prompt: "AIåŠ©ç†", translator_prompt: "ç¿»è­¯å“¡", translator_header: "å³æ™‚ç¿»è­¯", customer_speaker: "é¡§å®¢", staff_speaker: "å“¡å·¥", hold_to_speak: "èªªè©±", search_placeholder: "æœå°‹èªè¨€...", stop_btn: "åœæ­¢", select_language_title: "è«‹é¸æ“‡æ‚¨çš„èªè¨€", 
                welcome: "æ­¡è¿", first_time_title: "é€™æ˜¯æ‚¨ç¬¬ä¸€æ¬¡å…‰è‡¨å—ï¼Ÿ", yes_btn: "æ˜¯", no_btn: "å¦", 
                our_services_title: "æˆ‘å€‘çš„æœå‹™", our_services_subtitle: "æˆ‘å€‘æ˜¯åˆæ³•è¨»å†Šçš„æ©Ÿæ§‹ï¼Œæä¾›ä»¥ä¸‹æœå‹™ï¼š", ok_btn: "æŸ¥çœ‹åƒ¹æ ¼", 
                pricing_title: "æˆ‘å€‘çš„åƒ¹æ ¼", pricing_subtitle: "æˆ‘å€‘ä¼´éŠæœå‹™çš„åƒ¹æ ¼ç°¡å–®é€æ˜ã€‚",
                duration_60: "60åˆ†é˜", duration_90: "90åˆ†é˜", duration_120: "120åˆ†é˜",
                legal_reminder_title_serious: "ã€é‡è¦ã€‘å…è²¬è²æ˜ä¸ä½¿ç”¨æ¢æ¬¾", 
                legal_reminder_text_serious: "<p><strong>1. éµå®ˆæ³•å¾‹ï¼š</strong>æ ¹æ“šæ—¥æœ¬æ³•å¾‹ï¼Œåš´ç¦ç‚ºæ€§äº¤æ”¯ä»˜ä»»ä½•å½¢å¼çš„å ±é…¬ã€‚æœ¬æ©Ÿæ§‹å®Œå…¨éµå®ˆæ‰€æœ‰æ³•è¦ã€‚</p><p><strong>2. å®¢æˆ¶åˆä½œï¼š</strong>æˆ‘å€‘è¦æ±‚å®¢æˆ¶åˆä½œä»¥ç¶­è­·æ³•å¾‹ã€‚è«‹ä¸è¦è¦æ±‚åœ¨æ—¥æœ¬éæ³•çš„æœå‹™ã€‚</p><p><strong>3. æœå‹™æ€§è³ªï¼š</strong>æ‰€æœ‰è²»ç”¨åƒ…ç”¨æ–¼æˆ‘å€‘ä¼´ä¾¶çš„æ™‚é–“å’Œæ„‰å¿«é™ªä¼´ã€‚ç¹¼çºŒæ“ä½œå³è¡¨ç¤ºæ‚¨æ‰¿èªæ‚¨æ²’æœ‰ç‚ºä»»ä½•éæ³•è¡Œç‚ºä»˜è²»ã€‚</p>", 
                legal_reminder_agreement: "é»æ“Šã€ŒåŒæ„ã€ï¼Œå³è¡¨ç¤ºæ‚¨ç¢ºèªå·²é–±è®€ä¸¦ç†è§£é€™äº›æ¢æ¬¾ã€‚", 
                confirm_btn: "åŒæ„", reject_btn: "æ‹’çµ•", thank_you: "è¬è¬", rejection_text: "æ„Ÿè¬æ‚¨çš„é—œæ³¨ã€‚æˆ‘å€‘æœŸå¾…èƒ½å†æ¬¡ç‚ºæ‚¨æœå‹™ã€‚æ­£åœ¨é‡å®šå‘...", 
                welcome_back: "æ­¡è¿å›ä¾†ï¼", which_girl_title: "è«‹å•æ‚¨æœ‰æŒ‡å®šçš„å¥³ä¼´å—ï¼Ÿ", girl_name_placeholder: "è«‹è¼¸å…¥åŒä¼´çš„åå­—", 
                not_sure_btn: "æ²’æœ‰æŒ‡å®š", submit_continue_btn: "æäº¤ä¸¦ç¹¼çºŒ", form_success_text: "è¬è¬ï¼Œæˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„åå¥½ã€‚", 
                form_success_subtitle: "è«‹ç¹¼çºŒé–±è®€æ³•å¾‹è²æ˜ã€‚", continue_btn: "ç¹¼çºŒ", 
                services: ["æ¥å»", "æ‰‹äº¤", "èˆ”è›‹", "å£äº¤", "è§¸æ‘¸", "èˆ”èº«é«”", "69", "å£éƒ¨æœå‹™", "æ“æŠ±", "é™„åŠ é …ç›®ï¼ˆé¡å¤–æ”¶è²»ï¼‰"], 
                chat_header: "AIåŠ©ç†", error_speak_again: "ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹å†å°éº¥å…‹é¢¨èªªä¸€æ¬¡ã€‚" 
            }
        };
        const languageOptions = [ { code: 'en', name: "English" }, { code: 'ja', name: "æ—¥æœ¬èª (Japanese)" }, { code: 'zh', name: "ä¸­æ–‡ (ç®€ä½“)" }, { code: 'ko', name: "í•œêµ­ì–´ (Korean)" }, { code: 'es', name: "EspaÃ±ol (Spanish)" }, { code: 'zh-tw', name: "ä¸­æ–‡ (ç¹é«” - å»£æ±è©±/å°ç£è©±)" } ];

        // --- UI & CORE LOGIC ---
        const aiChatMessages = document.getElementById('ai-chat-messages');
        const aiConversationPanel = document.getElementById('conversation-panel');
        const translationChatMessages = document.getElementById('translation-chat-messages');
        const translationConversationPanel = document.getElementById('translation-panel');
        const bigMicBtn = document.getElementById('big-mic');
        const translateBtn = document.getElementById('translate-btn');
        const aiMicBtn = document.getElementById('ai-mic-btn');
        const translationMicBtn = document.getElementById('translation-mic-btn');
        let audioContext, analyser, dataArray, source, rafId;

        function updateText() {
            const langPack = translations[currentLanguage] || translations['en'];
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.getAttribute('data-translate-key');
                if (langPack[key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = langPack[key];
                        return; 
                    }
                    
                    if (key === 'legal_reminder_text_serious') {
                        el.innerHTML = langPack[key];
                        return;
                    }

                    const arrowKeys = ['continue_btn', 'ok_btn', 'confirm_btn', 'submit_continue_btn'];
                    const needsArrow = el.tagName === 'BUTTON' && arrowKeys.includes(key);

                    Array.from(el.childNodes).forEach(child => {
                        if (child.nodeType === 3) { 
                            el.removeChild(child);
                        }
                    });

                    const newText = langPack[key] + (needsArrow ? ' ' : '');
                    el.prepend(document.createTextNode(newText));

                    if (needsArrow && !el.querySelector('.btn-icon')) {
                        el.insertAdjacentHTML('beforeend', '<span class="btn-icon ml-2">&rarr;</span>');
                    }
                }
            });
            populateServices();
        }

        function populateLanguages(filter = '') {
            const list = document.getElementById('language-list');
            list.innerHTML = '';
            languageOptions.filter(lang => lang.name.toLowerCase().includes(filter.toLowerCase())).forEach(lang => {
                const li = document.createElement('li');
                li.textContent = lang.name;
                li.dataset.code = lang.code;
                li.className = 'px-4 py-2 hover:bg-pink-100 cursor-pointer';
                li.addEventListener('click', () => {
                    currentLanguage = lang.code;
                    document.getElementById('selected-language-name').textContent = lang.name;
                    document.getElementById('language-options').classList.add('hidden');
                    updateText();
                });
                list.appendChild(li);
            });
        }
        function populateServices() {
            const grid = document.querySelector('#page-services .grid');
            if (!grid) return;

            const englishServices = translations['en'].services;
            const translatedServices = translations[currentLanguage]?.services || englishServices;

            const serviceImageFilenames = {
                "69": "69.png",
                "Ball Licking": "Ball Licking.png",
                "Blowjob": "Blowjob.jpg",
                "Body Licking": "Body Licking.png",
                "Cuddling": "Cuddling.png",
                "Handjob": "Handjob.png",
                "Kissing": "Kissing.png",
                "Oral": "Oral.png",
                "Touching": "Touching.png",
                "Add-Ons (extra charge)": "Add-on.png"
            };

            grid.innerHTML = '';
            englishServices.forEach((englishService, index) => {
                const card = document.createElement('div');
                card.className = 'service-card';

                const filename = serviceImageFilenames[englishService] || 'placeholder.png';
                const imageUrl = `https://raw.githubusercontent.com/kozykenny/OperationFlow/main/${filename.replace(/ /g, '%20')}`;
                
                const translatedService = translatedServices[index]; 

                card.innerHTML = `<img src="${imageUrl}" alt="${translatedService}" onerror="this.onerror=null;this.src='https://placehold.co/400x200/fbcfe8/be185d?text=Image+Not+Found';"><p>${translatedService}</p>`;
                grid.appendChild(card);
            });
        }
        function showPage(pageId, isGoingBack = false) { 
            const currentPage = document.querySelector('.page-content.active'); 
            if (currentPage && !isGoingBack) pageHistory.push(currentPage.id); 
            document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active')); 
            const targetPage = document.getElementById(pageId); 
            if (targetPage) { 
                targetPage.classList.add('active'); 
                updateText(); 
            }
            const hideVoiceControls = pageId === 'page-language' || pageId === 'page-post-booking';
            document.querySelectorAll('.voice-control-container').forEach(el => {
                 el.style.display = hideVoiceControls ? 'none' : 'flex';
            });
        }

        function startOver() {
            pageHistory = [];
            showPage('page-language');
        }

        function goBack() { if (pageHistory.length > 0) { const prevPageId = pageHistory.pop(); showPage(prevPageId, true); } }
        
        function redirectToBooking() {
            let bookingUrl = 'https://tokyogirlshub.com/en/schedule'; // Default URL
            switch (currentLanguage) {
                case 'ko':
                    bookingUrl = 'https://tokyogirlshub.com/kr/schedule';
                    break;
                case 'zh':
                    bookingUrl = 'https://tokyogirlshub.com/zh-CN/schedule';
                    break;
                case 'zh-tw':
                    bookingUrl = 'https://tokyogirlshub.com/zh-TW/schedule';
                    break;
            }
            window.open(bookingUrl, '_blank');
            showPage('page-post-booking');
        }

        function handleRejection() { showPage('page-rejected'); setTimeout(() => { pageHistory = []; showPage('page-language'); }, 6000); }
        async function readResponseSafely(response) { const ct = response.headers.get('content-type') || ''; try { if (ct.includes('application/json')) return await response.json(); const text = await response.text(); return JSON.parse(text); } catch (_) { return { ok: response.ok, status: response.status }; } }
        
        async function sendNomination(girlName) {
            const payload = { session_id: getSessionId(), type: "nomination", payload: { girl_name: girlName, submitted_at: new Date().toISOString(), language: currentLanguage } };
            try {
                await fetch(n8nWebhookUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                showPage('page-form-success');
            } catch (error) {
                console.error('Error submitting nomination:', error);
                showPage('page-disclaimer-no');
            }
        }

        // --- DRAGGABLE LOGIC ---
        function makeDraggable(panel, header) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            header.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                const rect = panel.getBoundingClientRect();
                panel.style.top = rect.top + 'px';
                panel.style.left = rect.left + 'px';
                panel.style.right = 'auto'; 
                panel.style.bottom = 'auto';
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                panel.classList.add('dragging');
            }

            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                panel.style.top = (panel.offsetTop - pos2) + "px";
                panel.style.left = (panel.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                panel.classList.remove('dragging');
            }
        }
        
        // --- CONVERSATION & VOICE ---
        function closeAllPanels() {
            [aiConversationPanel, translationConversationPanel].forEach(panel => {
                panel.style.display = 'none';
            });
        }

        function addChatMessage(message, sender, panel) { const msgDiv = document.createElement('div'); msgDiv.className = `chat-message ${sender}-message`; msgDiv.innerHTML = message; panel.appendChild(msgDiv); panel.scrollTop = panel.scrollHeight; return msgDiv; }
        function addTypingIndicator(panel) { const wrap = document.createElement('div'); wrap.className = 'typing'; wrap.innerHTML = `<span>.</span><span>.</span><span>.</span>`; panel.appendChild(wrap); panel.scrollTop = panel.scrollHeight; return wrap; }
        
        async function sendAudioToWebhook(audioBlob) {
            const typingEl = addTypingIndicator(aiChatMessages);
            const fd = new FormData();
            fd.append('file', audioBlob, 'voice.webm');
            fd.append('session_id', getSessionId());
            fd.append('type', 'audio_chat');
            fd.append('language', currentLanguage);
            fd.append('history', JSON.stringify(chatHistory));
            try {
                const resp = await fetch(n8nWebhookUrl, { method: 'POST', body: fd });
                if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);
                const data = await readResponseSafely(resp);
                const transcribedText = data?.transcribed_text || "ğŸ¤ (Voice message received)";
                const aiResponse = data?.response || "Thank you, your message has been noted.";
                if (typingEl.parentNode) typingEl.remove();
                addChatMessage(transcribedText, 'user', aiChatMessages);
                chatHistory.push({ role: 'user', content: transcribedText });
                setTimeout(() => {
                    addChatMessage(aiResponse, 'ai', aiChatMessages);
                    chatHistory.push({ role: 'ai', content: aiResponse });
                }, 300);
            } catch (error) {
                console.error("Audio chat error:", error);
                if (typingEl && typingEl.parentNode) typingEl.remove();
                addChatMessage(translations[currentLanguage]?.error_speak_again || "An error occurred.", 'ai', aiChatMessages);
            }
        }

        async function sendAudioForTranslation(audioBlob) {
            const typingEl = addTypingIndicator(translationChatMessages);
            const fd = new FormData();
            fd.append('file', audioBlob, 'voice.webm');
            fd.append('session_id', getSessionId());
            fd.append('type', `translation_${currentSpeaker}`);
            fd.append('language', currentLanguage);
            try {
                const resp = await fetch(n8nWebhookUrl, { method: 'POST', body: fd });
                if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);
                const data = await readResponseSafely(resp);
                if (typingEl.parentNode) typingEl.remove();
                if (data.transcribed_text) {
                    const originalSender = currentSpeaker === 'customer' ? 'user' : 'staff';
                    let messageContent = data.transcribed_text;

                    if (data.response) {
                        messageContent += `<br><span class="translated-text">${data.response}</span>`;
                    } else {
                        messageContent += `<br><span class="translation-error">(No translation received)</span>`;
                    }
                    addChatMessage(messageContent, originalSender, translationChatMessages);
                }
            } catch (error) {
                console.error("Translation error:", error);
                if (typingEl && typingEl.parentNode) typingEl.remove();
                addChatMessage("Translation failed.", "ai", translationChatMessages);
            }
        }
        
        function handleMicButtonClick(e) {
            if (isRecording) {
                stopRecording();
            } else {
                activeMicBtn = e.currentTarget;
                startRecording();
            }
        }

        async function startRecording() {
            if (isRecording || !activeMicBtn) return;
            currentChatMode = activeMicBtn.id.includes('ai') ? 'ai' : 'translation';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioChunks = [];
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                isRecording = true;
                activeMicBtn.classList.add('recording');
                activeMicBtn.dataset.originalText = activeMicBtn.innerHTML;
                activeMicBtn.innerHTML = translations[currentLanguage]?.stop_btn || "Stop";

                mediaRecorder.addEventListener("dataavailable", (event) => { if (event.data?.size) audioChunks.push(event.data); });
                mediaRecorder.addEventListener("stop", () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    if(currentChatMode === 'ai') {
                        sendAudioToWebhook(audioBlob);
                    } else {
                        sendAudioForTranslation(audioBlob);
                    }
                    stream.getTracks().forEach(track => track.stop());
                });
            } catch (err) { alert("Microphone access is required. Please allow access and try again."); }
        }

        function stopRecording() {
            if (!isRecording) return;
            if (mediaRecorder?.state === "recording") mediaRecorder.stop();
            isRecording = false;
            
            const btn = activeMicBtn || document.querySelector('.record-btn.recording');
            if (btn) {
                btn.classList.remove('recording');
                btn.innerHTML = btn.dataset.originalText || (translations[currentLanguage]?.hold_to_speak || "Speak");
            }
            activeMicBtn = null;
        }

        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            const isVisible = panel.style.display === 'flex';
            closeAllPanels();
            if (!isVisible) {
                panel.style.display = 'flex';
            }
        }
        
        function setSpeaker(speaker) {
            currentSpeaker = speaker;
            const customerBtn = document.getElementById('speaker-customer');
            const staffBtn = document.getElementById('speaker-staff');
            const micBtn = document.getElementById('translation-mic-btn');
            
            micBtn.style.color = 'white';

            if (speaker === 'customer') {
                customerBtn.classList.add('active', 'customer');
                customerBtn.classList.remove('staff');
                staffBtn.classList.remove('active', 'customer', 'staff');
                micBtn.style.backgroundColor = 'var(--pink)';
                micBtn.style.borderColor = 'var(--pink)';
            } else { // staff
                staffBtn.classList.add('active', 'staff');
                staffBtn.classList.remove('customer');
                customerBtn.classList.remove('active', 'customer', 'staff');
                micBtn.style.backgroundColor = 'var(--violet)';
                micBtn.style.borderColor = 'var(--violet)';
            }
        }

        // --- INITIALIZATION ---
        function createBubbles() {
            const container = document.querySelector('.bubbles-container');
            if (!container) return;
            const bubbleCount = 40;
            const girlSilhouette = `<svg viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg"><path d="M88.7,28.6c-0.2-1.3-0.5-2.6-1-3.8c-1.4-3.6-4.1-6.5-7.7-7.9c-2.3-0.9-4.8-1.2-7.3-1c-5.2,0.4-10,3.3-12.8,7.7 c-2.2,3.4-3,7.6-2.2,11.7c0.5,2.4,1.5,4.7,2.9,6.6c-3.1,1.1-6,2.9-8.5,5.2c-4,3.7-6.5,8.8-7.2,14.3c-0.2,1.7-0.2,3.4,0,5.1 c0.1,0.9,0.3,1.7,0.5,2.6c2.3,8,8.4,14.3,16.5,16.5c1.4,0.4,2.8,0.6,4.3,0.8c5.4,0.6,10.6,0.6,16,0c0.9,0,1.8-0.1,2.7-0.2 c8.2-1.2,15.1-6.9,17.4-14.8c0.6-2,0.8-4.1,0.7-6.2c-0.2-4-1.3-7.8-3.4-11.2c-1.8-3-4.4-5.4-7.6-6.9c1.2-1.8,2-3.8,2.5-6 C90.1,34,89.6,31.2,88.7,28.6z"/></svg>`;

            for (let i = 0; i < bubbleCount; i++) {
                const bubble = document.createElement('div');
                
                const size = Math.random() * 80 + 20; // size between 20px and 100px
                bubble.style.width = `${size}px`;
                bubble.style.height = `${size}px`;
                bubble.style.left = `${Math.random() * 100}%`;
                bubble.style.animationDuration = `${Math.random() * 15 + 10}s`; // duration between 10s and 25s
                bubble.style.animationDelay = `${Math.random() * 10}s`;
                
                if (Math.random() > 0.75) { // 25% chance for a silhouette
                    bubble.className = 'bubble silhouette';
                    bubble.innerHTML = girlSilhouette;
                } else {
                    bubble.className = 'bubble circle';
                }
                
                container.appendChild(bubble);
            }
        }

        function init() {
            populateLanguages();
            createBubbles();
            const langButton = document.getElementById('language-select-button');
            const langOptions = document.getElementById('language-options');
            const langSearch = document.getElementById('language-search');
            langButton.addEventListener('click', () => langOptions.classList.toggle('hidden'));
            langSearch.addEventListener('input', (e) => populateLanguages(e.target.value));
            document.addEventListener('click', (e) => {
                const container = document.getElementById('custom-language-select');
                if (container && !container.contains(e.target)) langOptions.classList.add('hidden');
            });

            showPage('page-language');
            maybeExpireSession();
            updateText();
            document.querySelectorAll('.close-panel-btn').forEach(btn => btn.addEventListener('click', () => {
                closeAllPanels();
                if (isRecording) {
                    stopRecording();
                }
            }));
            
            document.getElementById('girl-nomination-form').addEventListener("submit", async function(event) {
                event.preventDefault();
                const girlNameInput = event.target.querySelector('input[name="girl_name"]');
                const girlName = girlNameInput.value.trim();
                if (girlName) await sendNomination(girlName);
            });
            document.getElementById('not-sure-btn').addEventListener('click', async () => await sendNomination('Not Sure'));
            
            document.getElementById('language-continue-btn').addEventListener('click', () => { 
                resetSession();
                if (document.getElementById('selected-language-name').textContent === 'Select Language') currentLanguage = 'en';
                updateText(); 
                showPage('page-first-time'); 
            });

            bigMicBtn.addEventListener('click', () => { currentChatMode = 'ai'; togglePanel('conversation-panel'); });
            translateBtn.addEventListener('click', () => { currentChatMode = 'translation'; togglePanel('translation-panel'); });
            
            document.getElementById('post-booking-ai-btn').addEventListener('click', () => togglePanel('conversation-panel'));
            document.getElementById('post-booking-translator-btn').addEventListener('click', () => togglePanel('translation-panel'));

            [aiMicBtn, translationMicBtn].forEach(btn => {
                btn.addEventListener('click', handleMicButtonClick);
            });

            document.getElementById('speaker-customer').addEventListener('click', () => setSpeaker('customer'));
            document.getElementById('speaker-staff').addEventListener('click', () => setSpeaker('staff'));
            
            makeDraggable(document.getElementById('conversation-panel'), document.querySelector('#conversation-panel .panel-header'));
            makeDraggable(document.getElementById('translation-panel'), document.querySelector('#translation-panel .panel-header'));

            setSpeaker('customer');
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

